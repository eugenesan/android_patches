From 40c4f1f8ec6d08d84be02c5f1d9db1b6b444eb71 Mon Sep 17 00:00:00 2001
From: "Eugene San (eugenesan)" <eugenesan@gmail.com>
Date: Tue, 1 Jan 2013 10:40:14 +0200
Subject: [PATCH] hybrid engine

Change-Id: Ic21ea4f6a92461859ce1215ae910b12db248f427
---
 core/java/android/app/ActivityThread.java          |   7 +
 core/java/android/app/ApplicationThreadNative.java |   1 -
 core/java/android/app/ContextImpl.java             |  93 +++-
 core/java/android/app/IApplicationThread.java      |   1 -
 core/java/android/app/IInstrumentationWatcher.aidl |   1 -
 core/java/android/app/ResultInfo.java              |   3 -
 core/java/android/content/IIntentSender.aidl       |   1 -
 core/java/android/content/res/AssetManager.java    |   3 +-
 .../android/content/res/CompatibilityInfo.java     |   2 -
 core/java/android/content/res/Configuration.java   |  30 +-
 core/java/android/content/res/Resources.java       |  21 +-
 .../android/preference/PreferenceActivity.java     |   5 +-
 core/java/android/provider/Settings.java           | 107 +++++
 core/java/android/util/DisplayMetrics.java         |  21 +-
 .../java/android/util/ExtendedPropertiesUtils.java | 483 +++++++++++++++++++++
 .../java/android/view/CompatibilityInfoHolder.java |   1 -
 core/java/android/view/DisplayInfo.java            |   3 +
 core/java/android/view/WindowManagerPolicy.java    |   5 +
 .../com/android/internal/app/ResolverActivity.java |  37 +-
 core/jni/Android.mk                                |   1 +
 core/jni/AndroidRuntime.cpp                        |   2 +
 core/jni/android_util_ExtendedPropertiesUtils.cpp  |  72 +++
 core/res/res/layout/resolver_grid_alt.xml          |  56 +++
 core/res/res/values-sw600dp/dimens.xml             |   4 +-
 core/res/res/values-sw720dp/dimens.xml             |  12 +-
 core/res/res/values/symbols.xml                    |   2 +
 graphics/java/android/graphics/Bitmap.java         |   3 +-
 packages/SystemUI/res/layout/status_bar.xml        |  17 +
 .../SystemUI/res/layout/status_bar_expanded.xml    |   5 +
 .../android/systemui/recent/RecentsPanelView.java  |  16 +-
 .../statusbar/phone/NotificationWallpaper.java     |  59 +++
 .../systemui/statusbar/phone/PhoneStatusBar.java   |  27 +-
 .../android/systemui/statusbar/policy/Clock.java   | 237 +++++-----
 .../systemui/statusbar/policy/ClockCenter.java     |  50 +++
 .../systemui/statusbar/policy/DateView.java        |   4 +-
 .../statusbar/policy/NetworkController.java        |   8 +
 .../systemui/statusbar/tablet/TabletStatusBar.java |  12 +
 .../internal/policy/impl/GlobalActions.java        |   4 +
 .../internal/policy/impl/PhoneWindowManager.java   | 103 ++++-
 .../internal/policy/impl/keyguard/CarrierText.java |  13 +-
 services/java/com/android/server/SystemServer.java |   3 +
 .../android/server/pm/PackageManagerService.java   |  20 +-
 .../android/server/wm/WindowManagerService.java    |  17 +
 43 files changed, 1376 insertions(+), 196 deletions(-)
 create mode 100644 core/java/android/util/ExtendedPropertiesUtils.java
 create mode 100644 core/jni/android_util_ExtendedPropertiesUtils.cpp
 create mode 100644 core/res/res/layout/resolver_grid_alt.xml
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/phone/NotificationWallpaper.java
 create mode 100644 packages/SystemUI/src/com/android/systemui/statusbar/policy/ClockCenter.java

diff --git a/core/java/android/app/ActivityThread.java b/core/java/android/app/ActivityThread.java
index 3c13fbb..0841a6f 100644
--- a/core/java/android/app/ActivityThread.java
+++ b/core/java/android/app/ActivityThread.java
@@ -85,6 +85,7 @@ import android.text.TextUtils;
 import android.util.AndroidRuntimeException;
 import android.util.DisplayMetrics;
 import android.util.EventLog;
+import android.util.ExtendedPropertiesUtils;
 import android.util.Log;
 import android.util.LogPrinter;
 import android.util.PrintWriterPrinter;
@@ -1710,12 +1711,14 @@ public final class ActivityThread {
 
         AssetManager assets = new AssetManager();
         assets.setThemeSupport(compInfo.isThemeable);
+        assets.overrideHook(resDir, ExtendedPropertiesUtils.OverrideMode.FullNameExclude);
         if (assets.addAssetPath(resDir) == 0) {
             return null;
         }
 
         //Slog.i(TAG, "Resource: key=" + key + ", display metrics=" + metrics);
         DisplayMetrics dm = getDisplayMetricsLocked(displayId, null);
+        dm.overrideHook(assets, ExtendedPropertiesUtils.OverrideMode.ExtendedProperties);
         Configuration config;
         boolean isDefaultDisplay = (displayId == Display.DEFAULT_DISPLAY);
         if (!isDefaultDisplay || key.mOverrideConfiguration != null) {
@@ -4299,6 +4302,8 @@ public final class ActivityThread {
     private void handleBindApplication(AppBindData data) {
         mBoundApplication = data;
         mConfiguration = new Configuration(data.config);
+        mConfiguration.active = true;
+        mConfiguration.overrideHook(data.processName, ExtendedPropertiesUtils.OverrideMode.PackageName);
         mCompatConfiguration = new Configuration(data.config);
 
         mProfiler = new Profiler();
@@ -5112,6 +5117,7 @@ public final class ActivityThread {
         HardwareRenderer.disable(true);
         ActivityThread thread = new ActivityThread();
         thread.attach(true);
+        ContextImpl.init(thread);
         return thread;
     }
 
@@ -5176,6 +5182,7 @@ public final class ActivityThread {
 
         ActivityThread thread = new ActivityThread();
         thread.attach(false);
+        ContextImpl.init(thread);
 
         if (sMainThreadHandler == null) {
             sMainThreadHandler = thread.getHandler();
diff --git a/core/java/android/app/ApplicationThreadNative.java b/core/java/android/app/ApplicationThreadNative.java
index 63aa5f9..0a30808 100644
--- a/core/java/android/app/ApplicationThreadNative.java
+++ b/core/java/android/app/ApplicationThreadNative.java
@@ -40,7 +40,6 @@ import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
 
-/** {@hide} */
 public abstract class ApplicationThreadNative extends Binder
         implements IApplicationThread {
     /**
diff --git a/core/java/android/app/ContextImpl.java b/core/java/android/app/ContextImpl.java
index 7439426..2fe82e8 100644
--- a/core/java/android/app/ContextImpl.java
+++ b/core/java/android/app/ContextImpl.java
@@ -96,6 +96,7 @@ import android.os.PowerManager;
 import android.os.Process;
 import android.os.RemoteException;
 import android.os.ServiceManager;
+import android.os.SystemProperties;
 import android.os.UserHandle;
 import android.os.SystemVibrator;
 import android.os.UserManager;
@@ -103,11 +104,11 @@ import android.os.storage.StorageManager;
 import android.telephony.TelephonyManager;
 import android.content.ClipboardManager;
 import android.util.AndroidRuntimeException;
-import android.util.Log;
-import android.util.Slog;
+import android.util.*;
 import android.view.CompatibilityInfoHolder;
 import android.view.ContextThemeWrapper;
 import android.view.Display;
+import android.view.WindowManager;
 import android.view.WindowManagerImpl;
 import android.view.accessibility.AccessibilityManager;
 import android.view.inputmethod.InputMethodManager;
@@ -1885,6 +1886,94 @@ class ContextImpl extends Context {
         mOuterContext = this;
     }
 
+    static void init(ActivityThread thread) {
+        if (ExtendedPropertiesUtils.mMainThread == null) {
+            try {
+                // If hybrid is not enabled, we cannot block the rest of the proccess,
+                // because it may cause a lot of misbehaviours, and avoiding initialization
+                // of vital variables used on ExtendedPropertiesUtils, may lead to crashes.
+                // Then we just set all applications to stock configuration. They will be
+                // still runned under hybrid engine.
+                if (ExtendedPropertiesUtils.getProperty(ExtendedPropertiesUtils.BEERBONG_PREFIX
+                        + "hybrid_mode").equals("1")) {
+                    ExtendedPropertiesUtils.mIsHybridModeEnabled = true;
+                }
+
+                // Save current thread into global context
+                ExtendedPropertiesUtils.mMainThread = thread;
+
+                // Load hashmap, in order to get latest properties
+                ExtendedPropertiesUtils.refreshProperties();
+
+                // Try to get the context for the current thread. If something
+                // goes wrong, we throw an exception.
+                ContextImpl context = createSystemContext(thread);
+                if (context == null) {
+                    throw new NullPointerException();
+                }
+
+                // If we sucessfully created the context, bind it to framework
+                LoadedApk info = new LoadedApk(thread, "android", context, null,
+                    CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO);
+                if (info == null) {
+                    throw new NullPointerException();
+                }
+
+                context.init(info, null, thread);
+                ExtendedPropertiesUtils.mContext = context;
+
+                // Get default display
+                WindowManager wm = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);
+                ExtendedPropertiesUtils.mDisplay = wm.getDefaultDisplay();
+                if (ExtendedPropertiesUtils.mDisplay == null) {
+                    throw new NullPointerException();
+                }
+
+                // Load package manager, so it's accessible system wide
+                ExtendedPropertiesUtils.mPackageManager = 
+                    ExtendedPropertiesUtils.mContext.getPackageManager();
+                if (ExtendedPropertiesUtils.mPackageManager == null) {
+                    throw new NullPointerException();
+                }
+
+                // Get package list and fetch PID
+                ExtendedPropertiesUtils.mPackageList = 
+                    ExtendedPropertiesUtils.mPackageManager.getInstalledPackages(0);
+                ExtendedPropertiesUtils.mGlobalHook.pid = android.os.Process.myPid();
+
+                // Initialize constants to be public. mIsTablet constant returns whether if 
+                // workspace we're working on is tablet workspace, or something different
+                ExtendedPropertiesUtils.mIsTablet = Integer.parseInt(ExtendedPropertiesUtils.getProperty
+                    ("com.android.systemui.layout")) >= 720;
+                ExtendedPropertiesUtils.mRomLcdDensity = SystemProperties.getInt("qemu.sf.lcd_density",
+                    SystemProperties.getInt("ro.sf.lcd_density", DisplayMetrics.DENSITY_DEFAULT));
+
+                // After we have PID, we get app info using it
+                ExtendedPropertiesUtils.mGlobalHook.info = 
+                    ExtendedPropertiesUtils.getAppInfoFromPID(ExtendedPropertiesUtils.mGlobalHook.pid);
+                if (ExtendedPropertiesUtils.mGlobalHook.info != null) {
+                    // If the global hook info isn't null, we load the name, package name
+                    // and path for the global hook
+                    ExtendedPropertiesUtils.mGlobalHook.name = 
+                        ExtendedPropertiesUtils.mGlobalHook.info.packageName;
+                    ExtendedPropertiesUtils.mGlobalHook.path = 
+                        ExtendedPropertiesUtils.mGlobalHook.info.sourceDir.substring(0,
+                        ExtendedPropertiesUtils.mGlobalHook.info.sourceDir.lastIndexOf("/"));
+                    ExtendedPropertiesUtils.setAppConfiguration(ExtendedPropertiesUtils.mGlobalHook);
+                } else {
+                    // We're dealing with "android" package. This is framework itself
+                    ExtendedPropertiesUtils.mGlobalHook.name = "android";
+                    ExtendedPropertiesUtils.mGlobalHook.path = "";
+                    ExtendedPropertiesUtils.setAppConfiguration(ExtendedPropertiesUtils.mGlobalHook);
+                }
+            } catch (Exception e) { 
+                // We use global exception to catch a lot of possible crashes.
+                // This is not a dirty workaround, but an expected behaviour
+                ExtendedPropertiesUtils.mMainThread = null;
+            }
+        }
+    }
+
     final void init(LoadedApk packageInfo, IBinder activityToken, ActivityThread mainThread) {
         init(packageInfo, activityToken, mainThread, null, null, Process.myUserHandle());
     }
diff --git a/core/java/android/app/IApplicationThread.java b/core/java/android/app/IApplicationThread.java
index 03a26d4..b4e3715 100644
--- a/core/java/android/app/IApplicationThread.java
+++ b/core/java/android/app/IApplicationThread.java
@@ -41,7 +41,6 @@ import java.util.Map;
  * the activity manager by an application  when it starts up, for the activity
  * manager to tell the application about things it needs to do.
  *
- * {@hide}
  */
 public interface IApplicationThread extends IInterface {
     void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving,
diff --git a/core/java/android/app/IInstrumentationWatcher.aidl b/core/java/android/app/IInstrumentationWatcher.aidl
index 6c8c4d6..8544421 100644
--- a/core/java/android/app/IInstrumentationWatcher.aidl
+++ b/core/java/android/app/IInstrumentationWatcher.aidl
@@ -20,7 +20,6 @@ package android.app;
 import android.content.ComponentName;
 import android.os.Bundle;
 
-/** @hide */
 interface IInstrumentationWatcher
 {
     void instrumentationStatus(in ComponentName name, int resultCode,
diff --git a/core/java/android/app/ResultInfo.java b/core/java/android/app/ResultInfo.java
index 48a0fc2..b0aeac1 100644
--- a/core/java/android/app/ResultInfo.java
+++ b/core/java/android/app/ResultInfo.java
@@ -24,9 +24,6 @@ import android.os.Bundle;
 
 import java.util.Map;
 
-/**
- * {@hide}
- */
 public class ResultInfo implements Parcelable {
     public final String mResultWho;
     public final int mRequestCode;
diff --git a/core/java/android/content/IIntentSender.aidl b/core/java/android/content/IIntentSender.aidl
index 7dbd6f2..223f434 100644
--- a/core/java/android/content/IIntentSender.aidl
+++ b/core/java/android/content/IIntentSender.aidl
@@ -19,7 +19,6 @@ package android.content;
 import android.content.IIntentReceiver;
 import android.content.Intent;
 
-/** @hide */
 interface IIntentSender {
     int send(int code, in Intent intent, String resolvedType,
             IIntentReceiver finishedReceiver, String requiredPermission);
diff --git a/core/java/android/content/res/AssetManager.java b/core/java/android/content/res/AssetManager.java
index 80d0946..44919cc 100644
--- a/core/java/android/content/res/AssetManager.java
+++ b/core/java/android/content/res/AssetManager.java
@@ -18,6 +18,7 @@
 package android.content.res;
 
 import android.os.ParcelFileDescriptor;
+import android.util.ExtendedPropertiesUtils;
 import android.util.Log;
 import android.util.SparseArray;
 import android.util.TypedValue;
@@ -34,7 +35,7 @@ import java.util.HashMap;
  * files that have been bundled with the application as a simple stream of
  * bytes.
  */
-public final class AssetManager {
+public final class AssetManager extends ExtendedPropertiesUtils {
     /* modes used when opening an asset */
 
     /**
diff --git a/core/java/android/content/res/CompatibilityInfo.java b/core/java/android/content/res/CompatibilityInfo.java
index 789d25e..1be2fd2 100644
--- a/core/java/android/content/res/CompatibilityInfo.java
+++ b/core/java/android/content/res/CompatibilityInfo.java
@@ -32,7 +32,6 @@ import android.view.WindowManager.LayoutParams;
  * CompatibilityInfo class keeps the information about compatibility mode that the application is
  * running under.
  * 
- *  {@hide} 
  */
 public class CompatibilityInfo implements Parcelable {
     /** default compatibility info object for compatible applications */
@@ -292,7 +291,6 @@ public class CompatibilityInfo implements Parcelable {
 
     /**
      * A helper object to translate the screen and window coordinates back and forth.
-     * @hide
      */
     public class Translator {
         final public float applicationScale;
diff --git a/core/java/android/content/res/Configuration.java b/core/java/android/content/res/Configuration.java
index 3a6d307..c01f956 100644
--- a/core/java/android/content/res/Configuration.java
+++ b/core/java/android/content/res/Configuration.java
@@ -18,10 +18,12 @@
 package android.content.res;
 
 import android.content.pm.ActivityInfo;
+import android.graphics.Point;
 import android.os.Parcel;
 import android.os.Parcelable;
 import android.text.TextUtils;
 import android.view.View;
+import android.util.ExtendedPropertiesUtils;
 import android.util.Log;
 import android.os.SystemProperties;
 import android.text.TextUtils;
@@ -38,7 +40,7 @@ import java.util.Locale;
  * with {@link android.app.Activity#getResources}:</p>
  * <pre>Configuration config = getResources().getConfiguration();</pre>
  */
-public final class Configuration implements Parcelable, Comparable<Configuration> {
+public final class Configuration extends ExtendedPropertiesUtils implements Parcelable, Comparable<Configuration> {
     /** @hide */
     public static final Configuration EMPTY = new Configuration();
 
@@ -563,6 +565,30 @@ public final class Configuration implements Parcelable, Comparable<Configuration
      */
     public int seq;
     
+    public boolean active;
+
+    /**
+     * Process layout changes for current hook
+     */
+    public void paranoidHook() {        
+        if (!"com.android.systemui".equals(getName()) && active) {
+            int dpi = getDpi(),
+                layout = 600;
+            if (dpi <= 213) {
+                layout = 720;
+            } else if (dpi > 213) {
+                layout = 360;
+            }
+            Point size = new Point();
+            if (mDisplay == null) return;
+            mDisplay.getSize(size);
+            float factor = (float)Math.max(size.x, size.y) / (float)Math.min(size.x, size.y);
+            screenWidthDp = layout;
+            screenHeightDp = (int)(screenWidthDp * factor);
+            smallestScreenWidthDp = layout;
+        }
+    }
+
     /**
      * Construct an invalid Configuration.  You must call {@link #setToDefaults}
      * for this object to be valid.  {@more}
@@ -606,6 +632,8 @@ public final class Configuration implements Parcelable, Comparable<Configuration
         if (o.customTheme != null) {
             customTheme = (CustomTheme) o.customTheme.clone();
         }
+
+        paranoidHook();
     }
     
     public String toString() {
diff --git a/core/java/android/content/res/Resources.java b/core/java/android/content/res/Resources.java
index c271f85..d2e4e49 100755
--- a/core/java/android/content/res/Resources.java
+++ b/core/java/android/content/res/Resources.java
@@ -30,6 +30,7 @@ import android.os.Build;
 import android.os.Bundle;
 import android.util.AttributeSet;
 import android.util.DisplayMetrics;
+import android.util.ExtendedPropertiesUtils;
 import android.util.Log;
 import android.util.Slog;
 import android.util.TypedValue;
@@ -67,7 +68,7 @@ import libcore.icu.NativePluralRules;
  * <p>For more information about using resources, see the documentation about <a
  * href="{@docRoot}guide/topics/resources/index.html">Application Resources</a>.</p>
  */
-public class Resources {
+public class Resources extends ExtendedPropertiesUtils {
     static final String TAG = "Resources";
     private static final boolean DEBUG_LOAD = false;
     private static final boolean DEBUG_CONFIG = false;
@@ -155,6 +156,22 @@ public class Resources {
     }
 
     /**
+     * Override current object with temp properties stored in enum interface
+     */
+    public void paranoidHook() {
+        mConfiguration.active = true;
+        mConfiguration.overrideHook(this, OverrideMode.ExtendedProperties);
+        mConfiguration.paranoidHook();
+
+        mTmpConfig.active = true;
+        mTmpConfig.overrideHook(this, OverrideMode.ExtendedProperties);
+        mTmpConfig.paranoidHook();
+
+        mMetrics.overrideHook(this, OverrideMode.ExtendedProperties);
+        mMetrics.paranoidHook();
+    }
+
+    /**
      * Create a new Resources object on top of an existing set of assets in an
      * AssetManager.
      * 
@@ -184,6 +201,8 @@ public class Resources {
             Configuration config, CompatibilityInfo compInfo) {
         mAssets = assets;
         mMetrics.setToDefaults();
+        overrideHook(assets, OverrideMode.ExtendedProperties);
+        paranoidHook();
         mCompatibilityInfo = compInfo;
         updateConfiguration(config, metrics);
         assets.ensureStringBlocks();
diff --git a/core/java/android/preference/PreferenceActivity.java b/core/java/android/preference/PreferenceActivity.java
index 09ff7be..c4502ce 100644
--- a/core/java/android/preference/PreferenceActivity.java
+++ b/core/java/android/preference/PreferenceActivity.java
@@ -26,6 +26,7 @@ import android.content.Intent;
 import android.content.res.Resources;
 import android.content.res.TypedArray;
 import android.content.res.XmlResourceParser;
+import android.provider.Settings;
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.Message;
@@ -679,9 +680,7 @@ public abstract class PreferenceActivity extends ListActivity implements
      * enough.
      */
     public boolean onIsMultiPane() {
-        boolean preferMultiPane = getResources().getBoolean(
-                com.android.internal.R.bool.preferences_prefer_dual_pane);
-        return preferMultiPane;
+        return Settings.System.getBoolean(getContentResolver(), Settings.System.FORCE_DUAL_PANEL, false);
     }
 
     /**
diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index a11eb1f..867f615 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -968,6 +968,113 @@ public final class Settings {
         }
 
         /**
+         * UIMode
+         */
+        public static final String UI_MODE = "ui_mode";
+        /**
+         * Force dual panel for settings
+         */
+        public static final String FORCE_DUAL_PANEL = "force_dualpanel";
+        /**
+         * Alpha settings for notification background
+         */
+        public static final String NOTIF_WALLPAPER_ALPHA = "notif_wallpaper_alpha";
+        /**
+         * Use alternative application resolver
+         */
+        public static final String ACTIVITY_RESOLVER_USE_ALT = "activity_resolver_use_alt";
+        /**
+         * Custom carrier label
+         */
+        public static final String CUSTOM_CARRIER_LABEL = "custom_carrier_label";
+        /**
+         * AM/PM Style for clock options
+         * 0 - Normal AM/PM
+         * 1 - Small AM/PM
+         * 2 - No AM/PM
+         * @hide
+         */
+        public static final String STATUSBAR_CLOCK_AM_PM_STYLE = "statusbar_clock_am_pm_style";
+        /**
+         * Style of clock
+         * 0 - Hide Clock
+         * 1 - Right Clock
+         * 2 - Center Clock
+         * @hide
+         */
+        public static final String STATUSBAR_CLOCK_STYLE = "statusbar_clock_style";
+        /**
+         * Setting for clock color
+         * @hide
+         */
+        public static final String STATUSBAR_CLOCK_COLOR = "statusbar_clock_color";
+        /**
+         * Shows weekday before clock time
+         * 0 - No Day
+         * 1 - Small Day
+         * 2 - Normal Day
+         * @hide
+         */
+        public static final String STATUSBAR_CLOCK_WEEKDAY = "statusbar_clock_weekday";
+        /**
+         * Prevent expand status bar when nav buttons are disabled
+         */
+        public static final String STATUSBAR_PREVENT_EXPAND = "statusbar_prevent_expand";
+        /**
+         * Prevent showing power menu when nav buttons are disabled
+         */
+        public static final String POWERMENU_PREVENT_SHOW = "powermenu_prevent_show";
+        /**
+         * Nav buttons are disabled
+         */
+        public static final String NAV_BUTTONS_ARE_DISABLED = "nav_buttons_are_disabled";
+        /**
+         * Navigation bar height
+         */
+        public static final String NAVIGATION_BAR_HEIGHT = "navigation_bar_height";
+        /**
+         * Navigation bar height in landscape mode
+         */
+        public static final String NAVIGATION_BAR_HEIGHT_LANDSCAPE = "navigation_bar_height_landscape";
+
+        /**
+         * Look up a boolean in the database.
+         * @param resolver to access the database with
+         * @param name to look up in the table
+         * @param def Value to return if the setting is not defined.
+         * @return The setting's current value, or 'def' if it is not defined
+         * or not a valid boolean.
+         */
+        public static boolean getBoolean(ContentResolver cr, String name, boolean def) {
+            String v = getString(cr, name);
+            try {
+                if(v != null)
+                    return "1".equals(v);
+                else
+                    return def;
+            } catch (NumberFormatException e) {
+                return def;
+            }
+        }
+
+        /**
+         * Convenience function for updating a single settings value as a
+         * boolean. This will either create a new entry in the table if the
+         * given name does not exist, or modify the value of the existing row
+         * with that name.  Note that internally setting values are always
+         * stored as strings, so this function converts the given value to a
+         * string before storing it.
+         *
+         * @param cr The ContentResolver to access.
+         * @param name The name of the setting to modify.
+         * @param value The new value for the setting.
+         * @return true if the value was set, false on database errors
+         */
+        public static boolean putBoolean(ContentResolver cr, String name, boolean value) {
+            return putString(cr, name, value ? "1" : "0");
+        }
+
+        /**
          * Look up a name in the database.
          * @param resolver to access the database with
          * @param name to look up in the table
diff --git a/core/java/android/util/DisplayMetrics.java b/core/java/android/util/DisplayMetrics.java
index 85e4b9d..89c56dc 100644
--- a/core/java/android/util/DisplayMetrics.java
+++ b/core/java/android/util/DisplayMetrics.java
@@ -26,7 +26,7 @@ import android.os.SystemProperties;
  * <pre> DisplayMetrics metrics = new DisplayMetrics();
  * getWindowManager().getDefaultDisplay().getMetrics(metrics);</pre>
  */
-public class DisplayMetrics {
+public class DisplayMetrics extends ExtendedPropertiesUtils {
     /**
      * Standard quantized DPI for low-density screens.
      */
@@ -183,6 +183,17 @@ public class DisplayMetrics {
      */
     public float noncompatYdpi;
 
+    /**
+     * Process DPI for current hook.
+     */
+    public void paranoidHook() {
+        if (getActive()) {
+            density = getDensity() == 0 ? density : getDensity();
+            scaledDensity = getScaledDensity() == 0 ? scaledDensity : getScaledDensity();
+            densityDpi = getDpi() == 0 ? densityDpi : getDpi();
+        }
+    }
+
     public DisplayMetrics() {
     }
     
@@ -201,6 +212,7 @@ public class DisplayMetrics {
         noncompatScaledDensity = o.noncompatScaledDensity;
         noncompatXdpi = o.noncompatXdpi;
         noncompatYdpi = o.noncompatYdpi;
+        paranoidHook();
     }
     
     public void setToDefaults() {
@@ -266,7 +278,10 @@ public class DisplayMetrics {
         // when running in the emulator, allowing for dynamic configurations.
         // The reason for this is that ro.sf.lcd_density is write-once and is
         // set by the init process when it parses build.prop before anything else.
-        return SystemProperties.getInt("qemu.sf.lcd_density",
-                SystemProperties.getInt("ro.sf.lcd_density", DENSITY_DEFAULT));
+        if (mGlobalHook.dpi == 0) {
+            return SystemProperties.getInt("qemu.sf.lcd_density",
+                    SystemProperties.getInt("ro.sf.lcd_density", DENSITY_DEFAULT));
+        }
+        return mGlobalHook.dpi;
     }
 }
diff --git a/core/java/android/util/ExtendedPropertiesUtils.java b/core/java/android/util/ExtendedPropertiesUtils.java
new file mode 100644
index 0000000..87905da
--- /dev/null
+++ b/core/java/android/util/ExtendedPropertiesUtils.java
@@ -0,0 +1,483 @@
+/*
+ * Copyright (C) 2012 ParanoidAndroid Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package android.util;
+
+import android.app.ActivityManager;
+import android.app.ActivityThread;
+import android.content.ContentResolver;
+import android.content.Context;
+import android.content.pm.ApplicationInfo;
+import android.content.pm.PackageInfo;
+import android.content.pm.PackageManager;
+import android.content.res.Resources;
+import android.content.res.CompatibilityInfo;
+import android.os.SystemProperties;
+import android.provider.Settings;
+import android.util.Log;
+import android.view.Display;
+
+import java.io.PrintWriter;
+import java.io.StringWriter;
+import java.lang.Math;
+import java.math.BigInteger;
+import java.nio.ByteBuffer;
+import java.nio.channels.FileChannel;
+import java.util.ArrayList;
+import java.util.HashMap;
+import java.util.Iterator;
+import java.util.List;
+
+public class ExtendedPropertiesUtils {
+
+    private static final String TAG = "ExtendedPropertiesUtils";
+
+    /**
+     * Public variables
+     */
+    public static final String BEERBONG_PROPERTIES = "/system/etc/beerbong/properties.conf";
+    public static final String BEERBONG_DIR = "/system/etc/beerbong/";
+    public static final String BEERBONG_MAINCONF = "properties.conf";
+    public static final String BEERBONG_BACKUPCONF = "backup.conf";
+    public static final String BEERBONG_PREFIX_0 = "mod";
+    public static final String BEERBONG_PREFIX_1 = "preferences";
+    public static final String BEERBONG_PREFIX_2 = "ro";
+    public static final String BEERBONG_PREFIX_3 = "com";
+    public static final String BEERBONG_PREFIX_4 = "version";
+    public static final String BEERBONG_PREFIX = "%";
+    public static final String BEERBONG_SEPARATOR = ".";
+    public static final String BEERBONG_STRING_DELIMITER = "\\|";
+    public static final String BEERBONG_DPI_SUFFIX = ".dpi";
+    public static final String BEERBONG_DENSITY_SUFFIX = ".den";
+    public static final String BEERBONG_SCALEDDENSITY_SUFFIX = ".sden";
+
+    public static HashMap<String, String> mPropertyMap = new HashMap<String, String>();
+    public static ActivityThread mMainThread;
+    public static Context mContext;
+    public static PackageManager mPackageManager;    
+    public static Display mDisplay;
+    public static List<PackageInfo> mPackageList;
+
+    public static BeerbongAppInfo mGlobalHook = new BeerbongAppInfo();
+    public BeerbongAppInfo mLocalHook = new BeerbongAppInfo();
+    public static boolean mIsHybridModeEnabled;
+
+    public static boolean mIsTablet;
+    public static int mRomLcdDensity = DisplayMetrics.DENSITY_DEFAULT;
+
+    public static native String readFile(String s);
+
+    /**
+     * Contains all the details for an application
+     */
+    public static class BeerbongAppInfo {
+        public String name = "";
+        public String path = "";
+        public boolean active;
+        public int pid;
+        public ApplicationInfo info;
+        public int dpi;
+        public float scaledDensity;
+        public float density;
+    }
+
+    /**
+     * Enum interface to allow different override modes
+     */
+    public static enum OverrideMode {
+        ExtendedProperties, AppInfo, FullName, FullNameExclude, PackageName
+    }
+
+    /**
+     * Set app configuration for the input argument <code>info</code>.
+     * This is done by fetching properties.conf or our stored {@link HashMap}.
+     *
+     * @param  info  instance containing app details
+     */
+    public static void setAppConfiguration(BeerbongAppInfo info) {
+
+        if(mIsHybridModeEnabled) {// && isEnvironmentSane()){
+            // Load default values to be used in case that property is 
+            // missing from configuration.
+            boolean isSystemApp = info.path.contains("system/app");
+            int defaultDpi = SystemProperties.getInt("qemu.sf.lcd_density", SystemProperties.getInt("ro.sf.lcd_density", DisplayMetrics.DENSITY_DEFAULT));
+
+            // DPI fetching.
+            info.dpi = Integer.parseInt(getProperty(info.name + BEERBONG_DPI_SUFFIX, String.valueOf(defaultDpi)));
+
+            // Extra density fetching.
+            info.density = Float.parseFloat(getProperty(info.name + BEERBONG_DENSITY_SUFFIX));
+            info.scaledDensity = Float.parseFloat(getProperty(info.name + BEERBONG_SCALEDDENSITY_SUFFIX));
+
+            // In case that densities aren't determined in previous step
+            // we calculate it by dividing DPI by default density (160).
+            if (info.dpi != 0) {
+                info.density = info.density == 0 ? info.dpi / (float) DisplayMetrics.DENSITY_DEFAULT : info.density;
+                info.scaledDensity = info.scaledDensity == 0 ? info.dpi / (float) DisplayMetrics.DENSITY_DEFAULT : info.scaledDensity;
+            }
+
+            // If everything went nice, stop parsing.
+            info.active = true;
+        }
+    }
+
+    /**
+     * Overrides current hook with input parameter <code>mode</code>, wich
+     * is an enum interface that stores basic override possibilities.
+     *
+     * @param  input  object to be overriden
+     * @param  mode  enum interface
+     */
+    public void overrideHook(Object input, OverrideMode mode) {
+
+        if (isInitialized() && input != null) {
+
+            ApplicationInfo tempInfo;
+            ExtendedPropertiesUtils tempProps;
+
+            switch (mode) {
+                case ExtendedProperties:
+                    tempProps = (ExtendedPropertiesUtils) input;
+
+                    if (tempProps.mLocalHook.active) {
+                        mLocalHook.active = tempProps.mLocalHook.active;
+                        mLocalHook.pid = tempProps.mLocalHook.pid;
+                        mLocalHook.info = tempProps.mLocalHook.info;
+                        mLocalHook.name = tempProps.mLocalHook.name;
+                        mLocalHook.path = tempProps.mLocalHook.path;
+                        mLocalHook.dpi = tempProps.mLocalHook.dpi;
+                        mLocalHook.scaledDensity = tempProps.mLocalHook.scaledDensity;
+                        mLocalHook.density = tempProps.mLocalHook.density;
+                    }
+                    return;
+                case AppInfo:
+                    mLocalHook.info = (ApplicationInfo)input;
+                    break;
+                case FullName:
+                    mLocalHook.info = getAppInfoFromPath((String) input);
+                    break;
+                case FullNameExclude:
+                    tempInfo = getAppInfoFromPath((String) input);
+                    if (tempInfo != null && (!isHooked())) {
+                        mLocalHook.info = tempInfo;
+                    }
+                    break;
+                case PackageName:
+                    mLocalHook.info = getAppInfoFromPackageName((String) input);
+                    break;
+            }
+
+            if (mLocalHook.info != null) {
+                mLocalHook.pid = android.os.Process.myPid();
+                mLocalHook.name = mLocalHook.info.packageName;
+                mLocalHook.path = mLocalHook.info.sourceDir.substring(0, mLocalHook.info.sourceDir.lastIndexOf("/"));
+
+                setAppConfiguration(mLocalHook);
+            }
+        }
+    }
+
+    /**
+     * This methods are used to retrieve specific information for a hook. 
+     */
+    public static boolean isInitialized() {
+        return (mContext != null);
+    }
+    public static boolean isHooked() {
+        return (isInitialized() && !mGlobalHook.name.equals("android") && !mGlobalHook.name.equals(""));
+    }
+    public boolean getActive() {
+        return mLocalHook.active ? mLocalHook.active : mGlobalHook.active;
+    }
+    public int getPid() {
+        return mLocalHook.active ? mLocalHook.pid : mGlobalHook.pid;
+    }
+    public ApplicationInfo getInfo() {
+        return mLocalHook.active ? mLocalHook.info : mGlobalHook.info;
+    }
+    public String getName() {
+        return mLocalHook.active ? mLocalHook.name : mGlobalHook.name;
+    }
+    public String getPath() {
+        return mLocalHook.active ? mLocalHook.path : mGlobalHook.path;
+    }
+    public int getDpi() {
+        return mLocalHook.active ? mLocalHook.dpi : mGlobalHook.dpi;
+    }
+    public float getScaledDensity() {
+        return mLocalHook.active ? mLocalHook.scaledDensity : mGlobalHook.scaledDensity;
+    }
+    public float getDensity() {
+        return mLocalHook.active ? mLocalHook.density : mGlobalHook.density;
+    }
+
+    /**
+     * Returns an {@link ApplicationInfo}, with the given path.
+     *
+     * @param  path  the apk path
+     * @return application info
+     */
+    public static ApplicationInfo getAppInfoFromPath(String path) {
+        if(isInitialized()) {
+            for(int i=0; mPackageList != null && i<mPackageList.size(); i++) {
+                PackageInfo p = mPackageList.get(i);
+                if (p.applicationInfo != null && p.applicationInfo.sourceDir.equals(path)) {
+                    return p.applicationInfo;
+                }
+            }
+        }
+        return null;
+    }
+
+    /**
+     * Returns an {@link ApplicationInfo}, with the given package name.
+     *
+     * @param  packageName  the application package name
+     * @return application info
+     */
+    public static ApplicationInfo getAppInfoFromPackageName(String packageName) {
+        if(isInitialized()) {
+            for(int i=0; mPackageList != null && i<mPackageList.size(); i++) {
+                PackageInfo p = mPackageList.get(i);
+                if (p.applicationInfo != null && p.applicationInfo.packageName.equals(packageName)) {
+                    return p.applicationInfo;
+                }
+            }
+        }
+        return null;
+    }
+
+    /**
+     * Returns an {@link ApplicationInfo}, with the given PID.
+     *
+     * @param  pid  the application PID
+     * @return application info
+     */
+    public static ApplicationInfo getAppInfoFromPID(int pid) {
+        if (isInitialized()) {
+            List mProcessList = ((ActivityManager)mContext.getSystemService(Context.ACTIVITY_SERVICE)).getRunningAppProcesses();
+            Iterator mProcessListIt = mProcessList.iterator();
+            while(mProcessListIt.hasNext()) {
+                ActivityManager.RunningAppProcessInfo mAppInfo = (ActivityManager.RunningAppProcessInfo)(mProcessListIt.next());
+                if(mAppInfo.pid == pid) {
+                    return getAppInfoFromPackageName(mAppInfo.processName);
+                }
+            }
+        }
+        return null;
+    }
+
+    /**
+     * Traces the input argument <code>msg</code> as a log.
+     * Used for debugging. Should not be used on public classes.
+     *
+     * @param  msg  the message to log
+     */
+    public static void traceMsg(String msg) {
+        StringWriter sw = new StringWriter();
+        new Throwable("").printStackTrace(new PrintWriter(sw));
+        String stackTrace = sw.toString();
+        Log.i(TAG + ":" + msg, "Trace=" + stackTrace);
+    }
+
+    /**
+     * Updates the {@link HashMap} that contains all the properties.
+     */
+    public static void refreshProperties() {
+        mPropertyMap.clear();
+        String[] props = readFile(BEERBONG_PROPERTIES).split("\n");
+        for(int i=0; i<props.length; i++) {
+            if (!props[i].startsWith("#")) {
+                String[] pair = props[i].split("=");
+                if (pair.length == 2) {
+                    mPropertyMap.put(pair[0].trim(), pair[1].trim());
+                }
+            }
+        }
+    }
+
+    /**
+     * Returns a {@link String}, containing the result of the configuration
+     * for the input argument <code>prop</code>. If the property is not found
+     * it returns zero.
+     *
+     * @param  prop  a string containing the property to checkout
+     * @return current stored value of property
+     */
+    public static String getProperty(String prop){
+        return getProperty(prop, String.valueOf(0));
+    }
+
+    /**
+     * Returns a {@link String}, containing the result of the configuration
+     * for the input argument <code>prop</code>. If the property is not found
+     * it returns the input argument <code>def</code>.
+     *
+     * @param  prop  a string containing the property to checkout
+     * @param  def  default value to be returned in case that property is missing
+     * @return current stored value of property
+     */
+    public static String getProperty(String prop, String def) {
+        try {
+            if(mGlobalHook.name.equals(BEERBONG_PREFIX_3 + BEERBONG_SEPARATOR + TAG + BEERBONG_SEPARATOR + BEERBONG_PREFIX_1)) {
+                String property1 = getAnyProperty(BEERBONG_DIR + BEERBONG_BACKUPCONF, BEERBONG_PREFIX_3 + BEERBONG_SEPARATOR + TAG + BEERBONG_SEPARATOR + BEERBONG_PREFIX_1 + BEERBONG_SEPARATOR + BEERBONG_PREFIX_4, "0");
+                String property2 = SystemProperties.get(BEERBONG_PREFIX_2 + BEERBONG_SEPARATOR + BEERBONG_PREFIX_0 + BEERBONG_PREFIX_4, "1");
+                if (!property1.equals(property2))
+                    return "0";
+            }
+
+            if (isInitialized()) {
+                String result = mPropertyMap.get(prop);
+                if (result == null) {
+                    return def;
+                }
+                if (result.startsWith(BEERBONG_PREFIX)) {
+                    result = getProperty(result, def);
+                }
+                return result;
+            } else {
+                String[] props = readFile(BEERBONG_PROPERTIES).split("\n");
+                for(int i=0; i<props.length; i++) {
+                    if(props[i].contains("=")) {
+                        if(props[i].substring(0, props[i].lastIndexOf("=")).equals(prop)) {
+                            String result = props[i].replace(prop+"=", "").trim();  
+                            if (result.startsWith(BEERBONG_PREFIX)) {
+                                result = getProperty(result, def);
+                            }
+                            return result;
+                        }
+                    }
+                }
+                return def;
+            }
+        } catch (NullPointerException e){
+            e.printStackTrace();
+        }
+        return def;
+    }
+
+    /**
+     * Returns a {@link String}, containing the result of the configuration
+     * for the input argument <code>prop</code>. If the property is not found
+     * it returns the input argument <code>def</code>.
+     *
+     * @properties  target property file
+     * @param  prop  a string containing the property to checkout
+     * @param  def  default value to be returned in case that property is missing
+     * @return current stored value of property
+     * TODO: Port to native code
+     */
+    public static String getAnyProperty(String properties, String prop, String def) {
+        try {
+            String[] props = readFile(properties).split("\n");
+            for(int i=0; i<props.length; i++) {
+                if(props[i].contains("=")) {
+                    if(props[i].substring(0, props[i].lastIndexOf("=")).equals(prop)) {
+                        String result = props[i].replace(prop+"=", "").trim();
+                        if (result.startsWith(BEERBONG_PREFIX)) {
+                            result = getProperty(result, def);
+                        }
+                        return result;
+                    }
+                }
+            }
+            return def;
+        } catch (NullPointerException e){
+            e.printStackTrace();
+        }
+        return def;
+    }
+
+    /**
+     * Returns an {@link Integer}, equivalent to what other classes will actually 
+     * load for the input argument <code>property</code>. it differs from 
+     * {@link #getProperty(String, String) getProperty}, because the values
+     * returned will never be zero.
+     *
+     * @param  property  a string containing the property to checkout
+     * @return the actual integer value of the selected property
+     * @see getProperty
+     */
+    public static int getActualProperty(String property) {
+        int result = -1;
+
+        if (property.endsWith(BEERBONG_DPI_SUFFIX)) {
+            ApplicationInfo appInfo = getAppInfoFromPackageName(property.substring(0, property.length() - BEERBONG_DPI_SUFFIX.length()));
+            boolean isSystemApp = appInfo.sourceDir.substring(0, appInfo.sourceDir.lastIndexOf("/")).contains("system/app");
+            result = Integer.parseInt(getProperty(property, "0"));
+        } else if (property.endsWith("_dpi")) {
+            result = Integer.parseInt(getProperty(property));
+        }
+
+        if (result == 0) {
+            result = SystemProperties.getInt("qemu.sf.lcd_density", SystemProperties.getInt("ro.sf.lcd_density", DisplayMetrics.DENSITY_DEFAULT));
+        }
+
+        return result;
+    }
+
+    /**
+     * Stores a boolean that will determine if the environment
+     * is sane and will allow hybrid to run without problems.
+     * We say that environment is sane, when native density
+     * (ro.sf.lcd_density) equals to "rom_default_dpi" parameter,
+     * and it's any of the possible values defined on {@link DisplayMetrics}
+     * class.
+     */
+    public static void getEnvironmentState() {
+        int nativeDensity = SystemProperties.getInt("qemu.sf.lcd_density", SystemProperties
+            .getInt("ro.sf.lcd_density", DisplayMetrics.DENSITY_DEFAULT));
+        switch(nativeDensity) {
+            case DisplayMetrics.DENSITY_LOW:
+            case DisplayMetrics.DENSITY_MEDIUM:
+            case DisplayMetrics.DENSITY_TV:
+            case DisplayMetrics.DENSITY_HIGH:
+            case DisplayMetrics.DENSITY_XHIGH:
+            case DisplayMetrics.DENSITY_XXHIGH:
+                setIsEnvironmentSane(true);
+                return;
+        }
+
+        setIsEnvironmentSane(false);
+    }
+
+    /**
+     * Method used by {@link #getEnvironmentState() getEnvironmentState}
+     * for storing whether if environment is sane or not.
+     *
+     * @param  state  environment state
+     * @see getEnvironmentState
+     */
+    public static void setIsEnvironmentSane(boolean state) {
+        SystemProperties.set("sys.environment", Integer.toString(state ? 1 : 0));
+    }
+
+    /**
+     * Returns a {@link Boolean}, if environment is sane.
+     *
+     * @return is environment sane
+     * @see getEnvironmentState
+     */
+    public static boolean isEnvironmentSane() {
+        return Integer.parseInt(SystemProperties.get("sys.environment", Integer.toString(0))) == 1;
+    }
+
+
+    public void debugOut(String msg) {
+        Log.i(TAG + ":" + msg, "Init=" + (mMainThread != null && mContext != null && 
+            mPackageManager != null) + " App=" + getName() + " Dpi=" + getDpi());
+    }
+}
diff --git a/core/java/android/view/CompatibilityInfoHolder.java b/core/java/android/view/CompatibilityInfoHolder.java
index fc8d684..6bab08d 100644
--- a/core/java/android/view/CompatibilityInfoHolder.java
+++ b/core/java/android/view/CompatibilityInfoHolder.java
@@ -18,7 +18,6 @@ package android.view;
 
 import android.content.res.CompatibilityInfo;
 
-/** @hide */
 public class CompatibilityInfoHolder {
     private volatile CompatibilityInfo mCompatInfo = CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO;
 
diff --git a/core/java/android/view/DisplayInfo.java b/core/java/android/view/DisplayInfo.java
index f3841d5..178a94e 100644
--- a/core/java/android/view/DisplayInfo.java
+++ b/core/java/android/view/DisplayInfo.java
@@ -296,6 +296,9 @@ public final class DisplayInfo implements Parcelable {
         outMetrics.scaledDensity = outMetrics.noncompatScaledDensity = outMetrics.density;
         outMetrics.xdpi = outMetrics.noncompatXdpi = physicalXDpi;
         outMetrics.ydpi = outMetrics.noncompatYdpi = physicalYDpi;
+        
+        if (outMetrics.isHooked())
+            outMetrics.paranoidHook();
 
         if (cih != null) {
             CompatibilityInfo ci = cih.getIfNeeded();
diff --git a/core/java/android/view/WindowManagerPolicy.java b/core/java/android/view/WindowManagerPolicy.java
index fd5449c..7eb788d 100644
--- a/core/java/android/view/WindowManagerPolicy.java
+++ b/core/java/android/view/WindowManagerPolicy.java
@@ -1143,4 +1143,9 @@ public interface WindowManagerPolicy {
      * {@link android.content.Intent#ACTION_ASSIST}
      */
     public void showAssistant();
+    
+    /**
+     * name of package being worked on durring boot time message.
+     */
+    public void setPackageName(String pkgName);
 }
diff --git a/core/java/com/android/internal/app/ResolverActivity.java b/core/java/com/android/internal/app/ResolverActivity.java
index e63c57f..6c1004a 100644
--- a/core/java/com/android/internal/app/ResolverActivity.java
+++ b/core/java/com/android/internal/app/ResolverActivity.java
@@ -38,6 +38,7 @@ import android.os.PatternMatcher;
 import android.os.Process;
 import android.os.RemoteException;
 import android.os.UserHandle;
+import android.provider.Settings;
 import android.util.Log;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -45,6 +46,7 @@ import android.view.ViewGroup;
 import android.widget.AdapterView;
 import android.widget.BaseAdapter;
 import android.widget.Button;
+import android.widget.CheckBox;
 import android.widget.GridView;
 import android.widget.ImageView;
 import android.widget.ListView;
@@ -73,12 +75,14 @@ public class ResolverActivity extends AlertActivity implements AdapterView.OnIte
     private GridView mGrid;
     private Button mAlwaysButton;
     private Button mOnceButton;
+    private CheckBox mAlwaysCheckBox;
     private int mIconDpi;
     private int mIconSize;
     private int mMaxColumns;
     private int mLastSelected = GridView.INVALID_POSITION;
 
     private boolean mRegistered;
+    private boolean mUseAltGrid;
     private final PackageMonitor mPackageMonitor = new PackageMonitor() {
         @Override public void onSomePackagesChanged() {
             mAdapter.handlePackagesChanged();
@@ -114,6 +118,7 @@ public class ResolverActivity extends AlertActivity implements AdapterView.OnIte
         } catch (RemoteException e) {
             mLaunchedFromUid = -1;
         }
+        mUseAltGrid = Settings.System.getBoolean(getContentResolver(), Settings.System.ACTIVITY_RESOLVER_USE_ALT, false);
         mPm = getPackageManager();
         mAlwaysUseOption = alwaysUseOption;
         mMaxColumns = getResources().getInteger(R.integer.config_maxResolverActivityColumns);
@@ -138,7 +143,11 @@ public class ResolverActivity extends AlertActivity implements AdapterView.OnIte
             finish();
             return;
         } else if (count > 1) {
-            ap.mView = getLayoutInflater().inflate(R.layout.resolver_grid, null);
+            if (mUseAltGrid) {
+                ap.mView = getLayoutInflater().inflate(R.layout.resolver_grid_alt, null);
+            } else {
+                ap.mView = getLayoutInflater().inflate(R.layout.resolver_grid, null);
+            }
             mGrid = (GridView) ap.mView.findViewById(R.id.resolver_grid);
             mGrid.setAdapter(mAdapter);
             mGrid.setOnItemClickListener(this);
@@ -165,8 +174,12 @@ public class ResolverActivity extends AlertActivity implements AdapterView.OnIte
             final ViewGroup buttonLayout = (ViewGroup) findViewById(R.id.button_bar);
             if (buttonLayout != null) {
                 buttonLayout.setVisibility(View.VISIBLE);
-                mAlwaysButton = (Button) buttonLayout.findViewById(R.id.button_always);
-                mOnceButton = (Button) buttonLayout.findViewById(R.id.button_once);
+                if (mUseAltGrid) {
+                    mAlwaysCheckBox = (CheckBox) buttonLayout.findViewById(R.id.checkbox_always);
+                } else {
+                    mAlwaysButton = (Button) buttonLayout.findViewById(R.id.button_always);
+                    mOnceButton = (Button) buttonLayout.findViewById(R.id.button_once);
+                }
             } else {
                 mAlwaysUseOption = false;
             }
@@ -249,8 +262,10 @@ public class ResolverActivity extends AlertActivity implements AdapterView.OnIte
             final int checkedPos = mGrid.getCheckedItemPosition();
             final boolean enabled = checkedPos != GridView.INVALID_POSITION;
             mLastSelected = checkedPos;
-            mAlwaysButton.setEnabled(enabled);
-            mOnceButton.setEnabled(enabled);
+            if (!mUseAltGrid) {
+                mAlwaysButton.setEnabled(enabled);
+                mOnceButton.setEnabled(enabled);
+            }
             if (enabled) {
                 mGrid.setSelection(checkedPos);
             }
@@ -262,10 +277,16 @@ public class ResolverActivity extends AlertActivity implements AdapterView.OnIte
         final int checkedPos = mGrid.getCheckedItemPosition();
         final boolean hasValidSelection = checkedPos != GridView.INVALID_POSITION;
         if (mAlwaysUseOption && (!hasValidSelection || mLastSelected != checkedPos)) {
-            mAlwaysButton.setEnabled(hasValidSelection);
-            mOnceButton.setEnabled(hasValidSelection);
+            if (!mUseAltGrid) {
+                mAlwaysButton.setEnabled(hasValidSelection);
+                mOnceButton.setEnabled(hasValidSelection);
+            }
             if (hasValidSelection) {
-                mGrid.smoothScrollToPosition(checkedPos);
+                if (mUseAltGrid) {
+                    startSelected(position,mAlwaysCheckBox.isChecked());
+                } else {
+                    mGrid.smoothScrollToPosition(checkedPos);
+                }
             }
             mLastSelected = checkedPos;
         } else {
diff --git a/core/jni/Android.mk b/core/jni/Android.mk
index de1fb4e..38511c3 100644
--- a/core/jni/Android.mk
+++ b/core/jni/Android.mk
@@ -81,6 +81,7 @@ LOCAL_SRC_FILES:= \
 	android_util_AssetManager.cpp \
 	android_util_Binder.cpp \
 	android_util_EventLog.cpp \
+	android_util_ExtendedPropertiesUtils.cpp \
 	android_util_Log.cpp \
 	android_util_FloatMath.cpp \
 	android_util_Process.cpp \
diff --git a/core/jni/AndroidRuntime.cpp b/core/jni/AndroidRuntime.cpp
index 01ad2f0..abeea13 100644
--- a/core/jni/AndroidRuntime.cpp
+++ b/core/jni/AndroidRuntime.cpp
@@ -99,6 +99,7 @@ namespace android {
 extern int register_android_content_AssetManager(JNIEnv* env);
 extern int register_android_util_EventLog(JNIEnv* env);
 extern int register_android_util_Log(JNIEnv* env);
+extern int register_android_util_ExtendedPropertiesUtils(JNIEnv* env);
 extern int register_android_content_StringBlock(JNIEnv* env);
 extern int register_android_content_XmlBlock(JNIEnv* env);
 extern int register_android_emoji_EmojiFactory(JNIEnv* env);
@@ -1103,6 +1104,7 @@ static const RegJNIRec gRegJNI[] = {
     REG_JNI(register_android_util_EventLog),
     REG_JNI(register_android_util_Log),
     REG_JNI(register_android_util_FloatMath),
+    REG_JNI(register_android_util_ExtendedPropertiesUtils),
     REG_JNI(register_android_text_format_Time),
     REG_JNI(register_android_content_AssetManager),
     REG_JNI(register_android_content_StringBlock),
diff --git a/core/jni/android_util_ExtendedPropertiesUtils.cpp b/core/jni/android_util_ExtendedPropertiesUtils.cpp
new file mode 100644
index 0000000..d76c641
--- /dev/null
+++ b/core/jni/android_util_ExtendedPropertiesUtils.cpp
@@ -0,0 +1,72 @@
+/*
+**
+** Copyright 2012, ParanoidAndroid Project
+**
+** Licensed under the Apache License, Version 2.0 (the "License");
+** you may not use this file except in compliance with the License.
+** You may obtain a copy of the License at
+**
+**     http://www.apache.org/licenses/LICENSE-2.0
+**
+** Unless required by applicable law or agreed to in writing, software
+** distributed under the License is distributed on an "AS IS" BASIS,
+** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+** See the License for the specific language governing permissions and
+** limitations under the License.
+*/
+
+#include <android/log.h>
+#include <android_runtime/AndroidRuntime.h>
+#include <jni.h>
+#include <JNIHelp.h>
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <time.h>
+#include <utils/misc.h>
+#include <wctype.h>
+
+namespace android {
+
+/*
+ *  In class android.util.ExtendedPropertiesUtils:
+ *  public static native String readFile(String msg)
+ */
+static jstring android_util_ExtendedPropertiesUtils_readFile(JNIEnv* env, jobject clazz, jstring msgObj)
+{
+    const char* msgString = env->GetStringUTFChars(msgObj, NULL);
+    FILE* file = fopen(msgString, "r");
+    if(file == NULL)
+        return NULL;
+
+    fseek(file, 0, SEEK_END);
+    long int size = ftell(file);
+    rewind(file);
+
+    char* content = (char*) calloc(size + 1, 1);
+
+    fread(content,1,size,file);
+
+    return env->NewStringUTF(content);
+}
+
+/*
+ * JNI registration.
+ */
+static JNINativeMethod gMethods[] = {
+    /* name, signature, funcPtr */
+    { "readFile",      "(Ljava/lang/String;)Ljava/lang/String;", (void*) android_util_ExtendedPropertiesUtils_readFile },
+};
+
+int register_android_util_ExtendedPropertiesUtils(JNIEnv* env)
+{
+    jclass clazz = env->FindClass("android/util/ExtendedPropertiesUtils");
+
+    if (clazz == NULL) {
+        return -1;
+    }
+
+    return AndroidRuntime::registerNativeMethods(env, "android/util/ExtendedPropertiesUtils", gMethods, NELEM(gMethods));
+}
+
+}; // namespace android
diff --git a/core/res/res/layout/resolver_grid_alt.xml b/core/res/res/layout/resolver_grid_alt.xml
new file mode 100644
index 0000000..7070fba
--- /dev/null
+++ b/core/res/res/layout/resolver_grid_alt.xml
@@ -0,0 +1,56 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+/*
+* Copyright 2012, The Android Open Source Project
+*
+* Licensed under the Apache License, Version 2.0 (the "License");
+* you may not use this file except in compliance with the License.
+* You may obtain a copy of the License at
+*
+*     http://www.apache.org/licenses/LICENSE-2.0
+*
+* Unless required by applicable law or agreed to in writing, software
+* distributed under the License is distributed on an "AS IS" BASIS,
+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+* See the License for the specific language governing permissions and
+* limitations under the License.
+*/
+-->
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+              android:layout_width="match_parent"
+              android:layout_height="match_parent"
+              android:orientation="vertical"
+              android:divider="?android:attr/dividerHorizontal"
+              android:showDividers="middle"
+              android:dividerPadding="0dip">
+    <FrameLayout android:layout_width="match_parent"
+                 android:layout_height="wrap_content"
+                 android:layout_weight="1">
+        <GridView
+            android:layout_gravity="center"
+            android:layout_width="wrap_content"
+            android:layout_height="match_parent"
+            android:id="@+id/resolver_grid"
+            android:numColumns="4"
+            android:columnWidth="128dp"
+            android:padding="16dp"
+            android:clipToPadding="false"
+            android:scrollbarStyle="outsideOverlay" />
+    </FrameLayout>
+    <LinearLayout
+        android:id="@+id/button_bar"
+        android:visibility="gone"
+        style="?android:attr/buttonBarStyle"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:orientation="horizontal"
+        android:layoutDirection="locale">
+        <CheckBox android:id="@+id/checkbox_always"
+                android:layout_width="wrap_content"
+                android:gravity="center"
+                android:textSize="14sp"
+                android:layout_height="wrap_content"
+                android:enabled="true"
+                android:text="@string/activity_resolver_use_always" />
+    </LinearLayout>
+</LinearLayout>
diff --git a/core/res/res/values-sw600dp/dimens.xml b/core/res/res/values-sw600dp/dimens.xml
index 52c230b..158dd52 100644
--- a/core/res/res/values-sw600dp/dimens.xml
+++ b/core/res/res/values-sw600dp/dimens.xml
@@ -75,8 +75,8 @@
     <dimen name="navigation_bar_height_portrait">56dp</dimen>
 
     <!-- Preference fragment padding, sides -->
-    <dimen name="preference_fragment_padding_side">24dp</dimen>
-    <dimen name="preference_screen_header_padding_side">24dip</dimen>
+    <dimen name="preference_fragment_padding_side">10dp</dimen>
+    <dimen name="preference_screen_header_padding_side">10dip</dimen>
 
     <!-- Keyguard dimensions -->
     <!-- Size of the clock font in keyguard's status view -->
diff --git a/core/res/res/values-sw720dp/dimens.xml b/core/res/res/values-sw720dp/dimens.xml
index ccdb4be..e039c0c 100644
--- a/core/res/res/values-sw720dp/dimens.xml
+++ b/core/res/res/values-sw720dp/dimens.xml
@@ -57,19 +57,19 @@
     <dimen name="default_app_widget_padding_bottom">20dp</dimen>
 
     <!-- Preference fragment padding, sides -->
-    <dimen name="preference_fragment_padding_side">32dp</dimen>
+    <dimen name="preference_fragment_padding_side">10dp</dimen>
     <!-- Padding to the left of the preference panel breadcrumb -->
-    <dimen name="preference_breadcrumb_paddingLeft">32dp</dimen>
+    <dimen name="preference_breadcrumb_paddingLeft">10dp</dimen>
     <!-- Padding to the right of the preference panel breadcrumb -->
-    <dimen name="preference_breadcrumb_paddingRight">32dp</dimen>
+    <dimen name="preference_breadcrumb_paddingRight">10dp</dimen>
     <!-- Weight of the left pane in a multi-pane preference layout. -->
-    <integer name="preferences_left_pane_weight">1</integer>
+    <integer name="preferences_left_pane_weight">3</integer>
     <!-- Weight of the right pane in a multi-pane preference layout. So the split is 1:2 -->
-    <integer name="preferences_right_pane_weight">2</integer>
+    <integer name="preferences_right_pane_weight">5</integer>
     <!-- Minimum space to allocate to the left of a preference item for an icon.
         This helps in aligning titles when some items have icons and some don't. When space is
         at a premium, we don't pre-allocate any space. -->
-    <dimen name="preference_icon_minWidth">56dp</dimen>
+    <dimen name="preference_icon_minWidth">0dp</dimen>
 
     <!-- Keyguard dimensions -->
     <!-- Size of the clock font in keyguard's status view -->
diff --git a/core/res/res/values/symbols.xml b/core/res/res/values/symbols.xml
index aec43db..e82095b 100644
--- a/core/res/res/values/symbols.xml
+++ b/core/res/res/values/symbols.xml
@@ -1697,9 +1697,11 @@
   <java-symbol type="string" name="enable_explore_by_touch_warning_message" />
 
   <java-symbol type="layout" name="resolver_grid" />
+  <java-symbol type="layout" name="resolver_grid_alt" />
   <java-symbol type="id" name="resolver_grid" />
   <java-symbol type="id" name="button_once" />
   <java-symbol type="id" name="button_always" />
+  <java-symbol type="id" name="checkbox_always" />
   <java-symbol type="integer" name="config_maxResolverActivityColumns" />
 
   <!-- From SystemUI -->
diff --git a/graphics/java/android/graphics/Bitmap.java b/graphics/java/android/graphics/Bitmap.java
index 688fd7a..6375337 100644
--- a/graphics/java/android/graphics/Bitmap.java
+++ b/graphics/java/android/graphics/Bitmap.java
@@ -19,6 +19,7 @@ package android.graphics;
 import android.os.Parcel;
 import android.os.Parcelable;
 import android.util.DisplayMetrics;
+import android.util.ExtendedPropertiesUtils;
 
 import java.io.OutputStream;
 import java.nio.Buffer;
@@ -80,7 +81,7 @@ public final class Bitmap implements Parcelable {
 
     static int getDefaultDensity() {
         if (sDefaultDensity >= 0) {
-            return sDefaultDensity;
+            return ExtendedPropertiesUtils.mGlobalHook.dpi == 0 ? sDefaultDensity : ExtendedPropertiesUtils.mGlobalHook.dpi;
         }
         sDefaultDensity = DisplayMetrics.DENSITY_DEVICE;
         return sDefaultDensity;
diff --git a/packages/SystemUI/res/layout/status_bar.xml b/packages/SystemUI/res/layout/status_bar.xml
index 2a4af96..6fb84e2 100644
--- a/packages/SystemUI/res/layout/status_bar.xml
+++ b/packages/SystemUI/res/layout/status_bar.xml
@@ -141,6 +141,23 @@
         </LinearLayout>
     </LinearLayout>
 
+    <LinearLayout
+        android:id="@+id/center_clock_layout"
+        android:gravity="center"
+        android:orientation="horizontal"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent" >
+
+        <com.android.systemui.statusbar.policy.ClockCenter
+            android:textAppearance="@style/TextAppearance.StatusBar.Clock"
+            android:gravity="center"
+            android:id="@+id/center_clock"
+            android:paddingLeft="6dip"
+            android:layout_width="wrap_content"
+            android:layout_height="match_parent"
+            android:singleLine="true" />
+    </LinearLayout>
+
     <LinearLayout android:id="@+id/ticker"
         android:layout_width="match_parent"
         android:layout_height="match_parent"
diff --git a/packages/SystemUI/res/layout/status_bar_expanded.xml b/packages/SystemUI/res/layout/status_bar_expanded.xml
index 06e7bd4..72def7d 100755
--- a/packages/SystemUI/res/layout/status_bar_expanded.xml
+++ b/packages/SystemUI/res/layout/status_bar_expanded.xml
@@ -29,6 +29,11 @@
     android:layout_marginLeft="@dimen/notification_panel_margin_left"
     >
 
+    <com.android.systemui.statusbar.phone.NotificationWallpaper
+        android:id="@+id/notification_wallpaper"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent" />
+
     <View
         android:id="@+id/handle"
         android:layout_width="match_parent"
diff --git a/packages/SystemUI/src/com/android/systemui/recent/RecentsPanelView.java b/packages/SystemUI/src/com/android/systemui/recent/RecentsPanelView.java
index dcb82d4..3948de2 100644
--- a/packages/SystemUI/src/com/android/systemui/recent/RecentsPanelView.java
+++ b/packages/SystemUI/src/com/android/systemui/recent/RecentsPanelView.java
@@ -39,6 +39,8 @@ import android.os.RemoteException;
 import android.os.UserHandle;
 import android.provider.Settings;
 import android.util.AttributeSet;
+import android.util.ExtendedPropertiesUtils;
+import android.util.DisplayMetrics;
 import android.util.Log;
 import android.view.LayoutInflater;
 import android.view.MenuItem;
@@ -85,10 +87,12 @@ public class RecentsPanelView extends FrameLayout implements OnItemClickListener
     private ArrayList<TaskDescription> mRecentTaskDescriptions;
     private TaskDescriptionAdapter mListAdapter;
     private int mThumbnailWidth;
+    private int mThumbnailHeight;
     private boolean mFitThumbnailToXY;
     private int mRecentItemLayoutId;
     private boolean mHighEndGfx;
     private ImageView mClearRecents;
+    private int mAndroidDpi = DisplayMetrics.DENSITY_DEVICE;
 
     public static interface RecentsScrollView {
         public int numItemsInOneScreenful();
@@ -145,6 +149,10 @@ public class RecentsPanelView extends FrameLayout implements OnItemClickListener
             holder.thumbnailView = convertView.findViewById(R.id.app_thumbnail);
             holder.thumbnailViewImage =
                     (ImageView) convertView.findViewById(R.id.app_thumbnail_image);
+
+            holder.thumbnailViewImage.getLayoutParams().width = mThumbnailWidth;
+            holder.thumbnailViewImage.getLayoutParams().height = mThumbnailHeight;
+
             // If we set the default thumbnail now, we avoid an onLayout when we update
             // the thumbnail later (if they both have the same dimensions)
             updateThumbnail(holder, mRecentTasksLoader.getDefaultThumbnail(), false, false);
@@ -412,8 +420,11 @@ public class RecentsPanelView extends FrameLayout implements OnItemClickListener
 
     public void updateValuesFromResources() {
         final Resources res = mContext.getResources();
-        mThumbnailWidth = Math.round(res.getDimension(R.dimen.status_bar_recents_thumbnail_width));
-        mFitThumbnailToXY = res.getBoolean(R.bool.config_recents_thumbnail_image_fits_to_xy);
+        mAndroidDpi = ExtendedPropertiesUtils.getActualProperty("com.android.systemui.dpi");
+        mThumbnailWidth = Math.round((float)res.getDimension(R.dimen.status_bar_recents_thumbnail_width) * 
+                DisplayMetrics.DENSITY_DEVICE / mAndroidDpi);
+        mThumbnailHeight = Math.round((float)res.getDimension(R.dimen.status_bar_recents_thumbnail_height) * 
+                DisplayMetrics.DENSITY_DEVICE / mAndroidDpi);
     }
 
     @Override
@@ -488,6 +499,7 @@ public class RecentsPanelView extends FrameLayout implements OnItemClickListener
             // Should remove the default image in the frame
             // that this now covers, to improve scrolling speed.
             // That can't be done until the anim is complete though.
+            thumbnail.setDensity(mAndroidDpi);
             h.thumbnailViewImage.setImageBitmap(thumbnail);
 
             // scale the image to fill the full width of the ImageView. do this only if
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/NotificationWallpaper.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NotificationWallpaper.java
new file mode 100644
index 0000000..89eb188
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/NotificationWallpaper.java
@@ -0,0 +1,59 @@
+package com.android.systemui.statusbar.phone;
+
+import java.io.File;
+
+import android.content.Context;
+import android.graphics.Bitmap;
+import android.graphics.BitmapFactory;
+import android.graphics.drawable.BitmapDrawable;
+import android.graphics.drawable.Drawable;
+import android.provider.Settings;
+import android.util.AttributeSet;
+import android.widget.FrameLayout;
+import android.widget.ImageView;
+import android.widget.ImageView.ScaleType;
+
+class NotificationWallpaper extends FrameLayout {
+
+    private final String TAG = "NotificationWallpaperUpdater";
+
+    private final String NOTIF_WALLPAPER_IMAGE_PATH = android.os.Environment.getExternalStorageDirectory().getAbsolutePath() + "/data/com.android.settings/notificationwallpaper.jpg";
+
+    private ImageView mNotificationWallpaperImage;
+
+    Bitmap bitmapWallpaper;
+
+    float wallpaperAlpha = Settings.System.getFloat(getContext()
+            .getContentResolver(), Settings.System.NOTIF_WALLPAPER_ALPHA, 1.0f);
+
+    public NotificationWallpaper(Context context, AttributeSet attrs) {
+        super(context);
+
+        setNotificationWallpaper();
+    }
+
+    public void setNotificationWallpaper() {
+        File file = new File(NOTIF_WALLPAPER_IMAGE_PATH);
+
+        if (file.exists()) {
+            mNotificationWallpaperImage = new ImageView(getContext());
+            mNotificationWallpaperImage.setScaleType(ScaleType.CENTER);
+            addView(mNotificationWallpaperImage, -1, -1);
+            bitmapWallpaper = BitmapFactory.decodeFile(NOTIF_WALLPAPER_IMAGE_PATH);
+            Drawable d = new BitmapDrawable(getResources(), bitmapWallpaper);
+            d.setAlpha((int) (wallpaperAlpha * 255));
+            mNotificationWallpaperImage.setImageDrawable(d);
+        } else {
+            removeAllViews();
+        }
+    }
+
+    @Override
+    protected void onDetachedFromWindow() {
+        if (bitmapWallpaper != null)
+            bitmapWallpaper.recycle();
+
+        System.gc();
+        super.onDetachedFromWindow();
+    }
+}
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java
index afde7f7..1b84acf 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java
@@ -1292,12 +1292,17 @@ public class PhoneStatusBar extends BaseStatusBar {
 
     public void showClock(boolean show) {
         if (mStatusBarView == null) return;
-        ContentResolver resolver = mContext.getContentResolver();
         View clock = mStatusBarView.findViewById(R.id.clock);
-        mShowClock = (Settings.System.getInt(resolver,
-                Settings.System.STATUS_BAR_CLOCK, 1) == 1);
-        if (clock != null) {
-            clock.setVisibility(show ? (mShowClock ? View.VISIBLE : View.GONE) : View.GONE);
+        View cclock = mStatusBarView.findViewById(R.id.center_clock);
+        boolean rightClock = (Settings.System.getInt(mContext.getContentResolver(),
+                Settings.System.STATUSBAR_CLOCK_STYLE, 1) == 1);
+        boolean centerClock = (Settings.System.getInt(mContext.getContentResolver(),
+                Settings.System.STATUSBAR_CLOCK_STYLE, 1) == 2);
+        if (rightClock && clock != null) {
+            clock.setVisibility(show ? View.VISIBLE : View.GONE);
+        }
+        if (centerClock && cclock != null) {
+            cclock.setVisibility(show ? View.VISIBLE : View.GONE);
         }
     }
 
@@ -1306,6 +1311,18 @@ public class PhoneStatusBar extends BaseStatusBar {
      */
     @Override
     public void disable(int state) {
+        
+        Settings.System.putBoolean(mContext.getContentResolver(), Settings.System.NAV_BUTTONS_ARE_DISABLED, false);
+               
+        if ((state & StatusBarManager.DISABLE_HOME) != 0 &&
+                (state & StatusBarManager.DISABLE_RECENT) != 0 &&
+                (state & StatusBarManager.DISABLE_BACK) != 0) {
+            Settings.System.putBoolean(mContext.getContentResolver(), Settings.System.NAV_BUTTONS_ARE_DISABLED, true);
+            if (Settings.System.getBoolean(mContext.getContentResolver(), Settings.System.STATUSBAR_PREVENT_EXPAND, false)) {
+                state = state | StatusBarManager.DISABLE_EXPAND;
+            }
+        }
+        
         final int old = mDisabled;
         final int diff = state ^ old;
         mDisabled = state;
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java b/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java
index cc071ee..3ecd219 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java
@@ -16,17 +16,17 @@
 
 package com.android.systemui.statusbar.policy;
 
-import android.app.ActivityManagerNative;
-import android.app.StatusBarManager;
+import java.text.SimpleDateFormat;
+import java.util.Calendar;
+import java.util.TimeZone;
+
 import android.content.BroadcastReceiver;
-import android.content.ComponentName;
 import android.content.ContentResolver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
 import android.database.ContentObserver;
 import android.os.Handler;
-import android.provider.AlarmClock;
 import android.provider.Settings;
 import android.text.Spannable;
 import android.text.SpannableStringBuilder;
@@ -35,21 +35,15 @@ import android.text.style.CharacterStyle;
 import android.text.style.RelativeSizeSpan;
 import android.util.AttributeSet;
 import android.view.View;
-import android.view.View.OnClickListener;
-import android.view.View.OnLongClickListener;
 import android.widget.TextView;
 
 import com.android.internal.R;
 
-import java.text.SimpleDateFormat;
-import java.util.Calendar;
-import java.util.TimeZone;
-
 /**
  * This widget display an analogic clock with two hands for hours and
  * minutes.
  */
-public class Clock extends TextView implements OnClickListener, OnLongClickListener {
+public class Clock extends TextView {
     private boolean mAttached;
     private Calendar mCalendar;
     private String mClockFormatString;
@@ -59,28 +53,21 @@ public class Clock extends TextView implements OnClickListener, OnLongClickListe
     private static final int AM_PM_STYLE_SMALL   = 1;
     private static final int AM_PM_STYLE_GONE    = 2;
 
-    private int mAmPmStyle = AM_PM_STYLE_GONE;
-    private boolean mShowClock;
+    protected int mAmPmStyle = AM_PM_STYLE_GONE;
 
-    Handler mHandler;
+    public static final int WEEKDAY_STYLE_GONE   = 0;
+    public static final int WEEKDAY_STYLE_SMALL  = 1;
+    public static final int WEEKDAY_STYLE_NORMAL = 2;
 
-    class SettingsObserver extends ContentObserver {
-        SettingsObserver(Handler handler) {
-            super(handler);
-        }
+    protected int mWeekdayStyle = WEEKDAY_STYLE_GONE;
 
-        void observe() {
-            ContentResolver resolver = mContext.getContentResolver();
-            resolver.registerContentObserver(Settings.System.getUriFor(
-                    Settings.System.STATUS_BAR_AM_PM), false, this);
-            resolver.registerContentObserver(Settings.System.getUriFor(
-                    Settings.System.STATUS_BAR_CLOCK), false, this);
-        }
+    public static final int STYLE_HIDE_CLOCK     = 0;
+    public static final int STYLE_CLOCK_RIGHT    = 1;
+    public static final int STYLE_CLOCK_CENTER   = 2;
 
-        @Override public void onChange(boolean selfChange) {
-            updateSettings();
-        }
-    }
+    protected int mClockStyle = STYLE_CLOCK_RIGHT;
+
+    protected int mClockColor = com.android.internal.R.color.holo_blue_light;
 
     public Clock(Context context) {
         this(context, null);
@@ -92,15 +79,6 @@ public class Clock extends TextView implements OnClickListener, OnLongClickListe
 
     public Clock(Context context, AttributeSet attrs, int defStyle) {
         super(context, attrs, defStyle);
-
-        mHandler = new Handler();
-        SettingsObserver settingsObserver = new SettingsObserver(mHandler);
-        settingsObserver.observe();
-        if(isClickable()){
-            setOnClickListener(this);
-            setOnLongClickListener(this);
-        }
-        updateSettings();
     }
 
     @Override
@@ -125,8 +103,9 @@ public class Clock extends TextView implements OnClickListener, OnLongClickListe
         // The time zone may have changed while the receiver wasn't registered, so update the Time
         mCalendar = Calendar.getInstance(TimeZone.getDefault());
 
-        // Make sure we update to the current time
-        updateClock();
+        SettingsObserver settingsObserver = new SettingsObserver(new Handler());
+        settingsObserver.observe();
+        updateSettings();
     }
 
     @Override
@@ -175,126 +154,116 @@ public class Clock extends TextView implements OnClickListener, OnLongClickListe
         SimpleDateFormat sdf;
         String format = context.getString(res);
         if (!format.equals(mClockFormatString)) {
-            /*
-             * Search for an unquoted "a" in the format string, so we can
-             * add dummy characters around it to let us find it again after
-             * formatting and change its size.
-             */
-            if (mAmPmStyle != AM_PM_STYLE_NORMAL) {
-                int a = -1;
-                boolean quoted = false;
-                for (int i = 0; i < format.length(); i++) {
-                    char c = format.charAt(i);
-
-                    if (c == '\'') {
-                        quoted = !quoted;
-                    }
-                    if (!quoted && c == 'a') {
-                        a = i;
-                        break;
-                    }
-                }
-
-                if (a >= 0) {
-                    // Move a back so any whitespace before AM/PM is also in the alternate size.
-                    final int b = a;
-                    while (a > 0 && Character.isWhitespace(format.charAt(a-1))) {
-                        a--;
-                    }
-                    format = format.substring(0, a) + MAGIC1 + format.substring(a, b)
-                        + "a" + MAGIC2 + format.substring(b + 1);
-                }
-            }
             mClockFormat = sdf = new SimpleDateFormat(format);
             mClockFormatString = format;
         } else {
             sdf = mClockFormat;
         }
+
+        Calendar calendar = Calendar.getInstance();
+        int day = calendar.get(Calendar.DAY_OF_WEEK);
+
+        String todayIs = null;
         String result = sdf.format(mCalendar.getTime());
 
-        if (mAmPmStyle != AM_PM_STYLE_NORMAL) {
-            int magic1 = result.indexOf(MAGIC1);
-            int magic2 = result.indexOf(MAGIC2);
-            if (magic1 >= 0 && magic2 > magic1) {
-                SpannableStringBuilder formatted = new SpannableStringBuilder(result);
+        if (mWeekdayStyle != WEEKDAY_STYLE_GONE) {
+            todayIs = (new SimpleDateFormat("E")).format(mCalendar.getTime()) + " ";
+            result = todayIs + result;
+        }
+
+        SpannableStringBuilder formatted = new SpannableStringBuilder(result);
+
+        if (!b24) {
+            if (mAmPmStyle != AM_PM_STYLE_NORMAL) {
+                String AmPm;
+                if (format.indexOf("a")==0) {
+                    AmPm = (new SimpleDateFormat("a ")).format(mCalendar.getTime());
+                } else {
+                    AmPm = (new SimpleDateFormat(" a")).format(mCalendar.getTime());
+                }
                 if (mAmPmStyle == AM_PM_STYLE_GONE) {
-                    formatted.delete(magic1, magic2+1);
+                    formatted.delete(result.indexOf(AmPm), result.lastIndexOf(AmPm)+AmPm.length());
                 } else {
                     if (mAmPmStyle == AM_PM_STYLE_SMALL) {
                         CharacterStyle style = new RelativeSizeSpan(0.7f);
-                        formatted.setSpan(style, magic1, magic2,
+                        formatted.setSpan(style, result.indexOf(AmPm), result.lastIndexOf(AmPm)+AmPm.length(),
+                                Spannable.SPAN_EXCLUSIVE_INCLUSIVE);
+                    }
+                }
+            }
+        }
+        if (mWeekdayStyle != WEEKDAY_STYLE_NORMAL) {
+            if (todayIs != null) {
+                if (mWeekdayStyle == WEEKDAY_STYLE_GONE) {
+                    formatted.delete(result.indexOf(todayIs), result.lastIndexOf(todayIs)+todayIs.length());
+                } else {
+                    if (mWeekdayStyle == WEEKDAY_STYLE_SMALL) {
+                        CharacterStyle style = new RelativeSizeSpan(0.7f);
+                        formatted.setSpan(style, result.indexOf(todayIs), result.lastIndexOf(todayIs)+todayIs.length(),
                                           Spannable.SPAN_EXCLUSIVE_INCLUSIVE);
                     }
-                    formatted.delete(magic2, magic2 + 1);
-                    formatted.delete(magic1, magic1 + 1);
                 }
-                return formatted;
             }
         }
-
-        return result;
-
+        return formatted;
     }
 
-    private void updateSettings(){
-        ContentResolver resolver = mContext.getContentResolver();
-
-        int amPmStyle = (Settings.System.getInt(resolver,
-                Settings.System.STATUS_BAR_AM_PM, 2));
-
-        if (mAmPmStyle != amPmStyle) {
-            mAmPmStyle = amPmStyle;
-            mClockFormatString = "";
-
-            if (mAttached) {
-                updateClock();
-            }
+    protected class SettingsObserver extends ContentObserver {
+        SettingsObserver(Handler handler) {
+            super(handler);
         }
 
-        mShowClock = (Settings.System.getInt(resolver,
-                Settings.System.STATUS_BAR_CLOCK, 1) == 1);
+        void observe() {
+            ContentResolver resolver = mContext.getContentResolver();
+            resolver.registerContentObserver(Settings.System
+                    .getUriFor(Settings.System.STATUSBAR_CLOCK_AM_PM_STYLE),
+                    false, this);
+            resolver.registerContentObserver(Settings.System
+                    .getUriFor(Settings.System.STATUSBAR_CLOCK_STYLE), false,
+                    this);
+            resolver.registerContentObserver(Settings.System
+                    .getUriFor(Settings.System.STATUSBAR_CLOCK_COLOR), false,
+                    this);
+            resolver.registerContentObserver(Settings.System
+                    .getUriFor(Settings.System.STATUSBAR_CLOCK_WEEKDAY), false,
+                    this);
+            updateSettings();
+        }
 
-        if(mShowClock)
-            setVisibility(View.VISIBLE);
-        else
-            setVisibility(View.GONE);
+        @Override
+        public void onChange(boolean selfChange) {
+            updateSettings();
+        }
     }
 
-    private void collapseStartActivity(Intent what) {
-        // collapse status bar
-        StatusBarManager statusBarManager = (StatusBarManager) getContext().getSystemService(
-                Context.STATUS_BAR_SERVICE);
-        statusBarManager.collapsePanels();
-
-        // dismiss keyguard in case it was active and no passcode set
-        try {
-            ActivityManagerNative.getDefault().dismissKeyguardOnNextActivity();
-        } catch (Exception ex) {
-            // no action needed here
+    protected void updateSettings() {
+        ContentResolver resolver = mContext.getContentResolver();
+        int defaultColor = getResources().getColor(
+                com.android.internal.R.color.holo_blue_light);
+
+        mAmPmStyle = Settings.System.getInt(resolver,
+                Settings.System.STATUSBAR_CLOCK_AM_PM_STYLE, AM_PM_STYLE_GONE);   
+        mClockStyle = Settings.System.getInt(resolver,
+                Settings.System.STATUSBAR_CLOCK_STYLE, STYLE_CLOCK_RIGHT);
+        mWeekdayStyle = Settings.System.getInt(resolver,
+                Settings.System.STATUSBAR_CLOCK_WEEKDAY, WEEKDAY_STYLE_GONE);
+
+        mClockColor = Settings.System.getInt(resolver,
+                Settings.System.STATUSBAR_CLOCK_COLOR, defaultColor);
+        if (mClockColor == Integer.MIN_VALUE) {
+            // flag to reset the color
+            mClockColor = defaultColor;
         }
+        setTextColor(mClockColor);
 
-        // start activity
-        what.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
-        mContext.startActivity(what);
-    }
-
-    @Override
-    public void onClick(View v) {
-        // start com.android.deskclock/.DeskClock
-        ComponentName clock = new ComponentName("com.android.deskclock",
-                "com.android.deskclock.DeskClock");
-        Intent intent = new Intent(Intent.ACTION_MAIN).addCategory(Intent.CATEGORY_LAUNCHER)
-                .setComponent(clock);
-        collapseStartActivity(intent);
+        updateClockVisibility();
+        updateClock();
     }
 
-    @Override
-    public boolean onLongClick(View v) {
-        Intent intent = new Intent(AlarmClock.ACTION_SET_ALARM);
-        collapseStartActivity(intent);
-
-        // consume event
-        return true;
+    protected void updateClockVisibility() {
+        if (mClockStyle == STYLE_CLOCK_RIGHT)
+            setVisibility(View.VISIBLE);
+        else
+            setVisibility(View.GONE);
     }
 }
-
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/policy/ClockCenter.java b/packages/SystemUI/src/com/android/systemui/statusbar/policy/ClockCenter.java
new file mode 100644
index 0000000..876ec8d
--- /dev/null
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/policy/ClockCenter.java
@@ -0,0 +1,50 @@
+/*
+ * Copyright (C) 2006 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.systemui.statusbar.policy;
+
+import android.content.Context;
+import android.os.Handler;
+import android.util.AttributeSet;
+import android.view.View;
+
+public class ClockCenter extends Clock {
+
+    public ClockCenter(Context context) {
+        this(context, null);
+    }
+
+    public ClockCenter(Context context, AttributeSet attrs) {
+        this(context, attrs, 0);
+    }
+
+    public ClockCenter(Context context, AttributeSet attrs, int defStyle) {
+        super(context, attrs, defStyle);
+    }
+
+    public void updateVisibilityFromStatusBar(boolean show) {
+        if (mClockStyle == STYLE_CLOCK_CENTER)
+            setVisibility(show ? View.VISIBLE : View.GONE);
+
+    }
+
+    protected void updateClockVisibility() {
+        if (mClockStyle == STYLE_CLOCK_CENTER)
+            setVisibility(View.VISIBLE);
+        else
+            setVisibility(View.GONE);
+    }
+}
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/policy/DateView.java b/packages/SystemUI/src/com/android/systemui/statusbar/policy/DateView.java
index 7378ade..8a2f633 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/policy/DateView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/policy/DateView.java
@@ -42,7 +42,7 @@ import java.util.Date;
 public class DateView extends TextView implements OnClickListener, OnLongClickListener {
     private static final String TAG = "DateView";
 
-    private RelativeLayout mParent;
+    private View mParent;
 
     private boolean mAttachedToWindow;
     private boolean mWindowVisible;
@@ -88,7 +88,7 @@ public class DateView extends TextView implements OnClickListener, OnLongClickLi
     @Override
     protected void onDraw(Canvas canvas) {
         if (mParent == null) {
-            mParent = (RelativeLayout) getParent();
+            mParent = (View) getParent();
             mParent.setOnClickListener(this);
             mParent.setOnLongClickListener(this);
         }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/policy/NetworkController.java b/packages/SystemUI/src/com/android/systemui/statusbar/policy/NetworkController.java
index 19d9f8c..7d9b6b3 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/policy/NetworkController.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/policy/NetworkController.java
@@ -1006,6 +1006,8 @@ public class NetworkController extends BroadcastReceiver {
         String mobileLabel = "";
         int N;
         final boolean emergencyOnly = isEmergencyOnly();
+        final String customLabel = Settings.System.getString(mContext.getContentResolver(),
+                Settings.System.CUSTOM_CARRIER_LABEL);
 
         if (!mHasMobileDataFeature) {
             mDataSignalIconId = mPhoneSignalIconId = 0;
@@ -1161,6 +1163,12 @@ public class NetworkController extends BroadcastReceiver {
             }
         }
 
+        if (customLabel != null && customLabel.length() > 0) {  
+            combinedLabel = customLabel;    
+            mobileLabel = customLabel;  
+            wifiLabel = customLabel;    
+        }
+
         if (DEBUG) {
             Slog.d(TAG, "refreshViews connected={"
                     + (mWifiConnected?" wifi":"")
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/tablet/TabletStatusBar.java b/packages/SystemUI/src/com/android/systemui/statusbar/tablet/TabletStatusBar.java
index 246c7b5..34ed143 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/tablet/TabletStatusBar.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/tablet/TabletStatusBar.java
@@ -951,6 +951,18 @@ public class TabletStatusBar extends BaseStatusBar implements
     }
 
     public void disable(int state) {
+        
+        Settings.System.putBoolean(mContext.getContentResolver(), Settings.System.NAV_BUTTONS_ARE_DISABLED, false);
+               
+        if ((state & StatusBarManager.DISABLE_HOME) != 0 &&
+                (state & StatusBarManager.DISABLE_RECENT) != 0 &&
+                (state & StatusBarManager.DISABLE_BACK) != 0) {
+            Settings.System.putBoolean(mContext.getContentResolver(), Settings.System.NAV_BUTTONS_ARE_DISABLED, true);
+            if (Settings.System.getBoolean(mContext.getContentResolver(), Settings.System.STATUSBAR_PREVENT_EXPAND, false)) {
+                state = state | StatusBarManager.DISABLE_EXPAND;
+            }
+        }
+        
         int old = mDisabled;
         int diff = state ^ old;
         mDisabled = state;
diff --git a/policy/src/com/android/internal/policy/impl/GlobalActions.java b/policy/src/com/android/internal/policy/impl/GlobalActions.java
index f16482f..2b29fb9 100644
--- a/policy/src/com/android/internal/policy/impl/GlobalActions.java
+++ b/policy/src/com/android/internal/policy/impl/GlobalActions.java
@@ -161,6 +161,10 @@ class GlobalActions implements DialogInterface.OnDismissListener, DialogInterfac
      * @param keyguardShowing True if keyguard is showing
      */
     public void showDialog(boolean keyguardShowing, boolean isDeviceProvisioned) {
+        if (Settings.System.getBoolean(mContext.getContentResolver(), Settings.System.POWERMENU_PREVENT_SHOW, false) &&
+                Settings.System.getBoolean(mContext.getContentResolver(), Settings.System.NAV_BUTTONS_ARE_DISABLED, false)) {
+            return;
+        }
         mKeyguardShowing = keyguardShowing;
         mDeviceProvisioned = isDeviceProvisioned;
         if (mDialog != null && mUiContext == null) {
diff --git a/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java b/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
index 4af592d..38c05e7 100755
--- a/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
+++ b/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
@@ -301,6 +301,8 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     boolean mNavigationBarOnBottom = true; // is the navigation bar on the bottom *right now*?
     int[] mNavigationBarHeightForRotation = new int[4];
     int[] mNavigationBarWidthForRotation = new int[4];
+    int mUserNavBarHeight;
+    int mUserNavBarHeightLand;
 
     WindowState mKeyguard = null;
     KeyguardViewMediator mKeyguardMediator;
@@ -642,6 +644,10 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                     Settings.System.KEY_APP_SWITCH_LONG_PRESS_ACTION), false, this);
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.HARDWARE_KEY_REBINDING), false, this);
+            resolver.registerContentObserver(Settings.System.getUriFor(
+                    Settings.System.NAVIGATION_BAR_HEIGHT), false, this);
+            resolver.registerContentObserver(Settings.System.getUriFor(
+                    Settings.System.NAVIGATION_BAR_HEIGHT_LANDSCAPE), false, this);
 
             updateSettings();
         }
@@ -1225,15 +1231,38 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         mStatusBarHeight = mContext.getResources().getDimensionPixelSize(
                 com.android.internal.R.dimen.status_bar_height);
 
-        // Height of the navigation bar when presented horizontally at bottom
-        mNavigationBarHeightForRotation[mPortraitRotation] =
-        mNavigationBarHeightForRotation[mUpsideDownRotation] =
-                mContext.getResources().getDimensionPixelSize(
-                        com.android.internal.R.dimen.navigation_bar_height);
-        mNavigationBarHeightForRotation[mLandscapeRotation] =
-        mNavigationBarHeightForRotation[mSeascapeRotation] =
-                mContext.getResources().getDimensionPixelSize(
-                        com.android.internal.R.dimen.navigation_bar_height_landscape);
+        int uiMode = Settings.System.getInt(mContext.getContentResolver(), Settings.System.UI_MODE, 0);
+
+        if (uiMode ==3) {
+            // Height of the navigation bar when presented horizontally at bottom
+            mNavigationBarHeightForRotation[mPortraitRotation] =
+            mNavigationBarHeightForRotation[mUpsideDownRotation] =
+                    mContext.getResources().getDimensionPixelSize(
+                            com.android.internal.R.dimen.navigation_bar_height);
+            mNavigationBarHeightForRotation[mLandscapeRotation] =
+            mNavigationBarHeightForRotation[mSeascapeRotation] =
+                    mContext.getResources().getDimensionPixelSize(
+                            com.android.internal.R.dimen.navigation_bar_height_landscape);
+        } else {
+            // Height of the navigation bar when presented horizontally at bottom
+            mNavigationBarHeightForRotation[mPortraitRotation] =
+            mNavigationBarHeightForRotation[mUpsideDownRotation] =
+                    Settings.System.getInt(
+                        mContext.getContentResolver(),
+                        Settings.System.NAVIGATION_BAR_HEIGHT,
+                        mContext.getResources()
+                                .getDimensionPixelSize(
+                                        com.android.internal.R.dimen.navigation_bar_height));
+
+            mNavigationBarHeightForRotation[mLandscapeRotation] =
+            mNavigationBarHeightForRotation[mSeascapeRotation] =
+                    Settings.System.getInt(
+                        mContext.getContentResolver(),
+                        Settings.System.NAVIGATION_BAR_HEIGHT_LANDSCAPE,
+                        mContext.getResources()
+                                .getDimensionPixelSize(
+                                        com.android.internal.R.dimen.navigation_bar_height_landscape));
+        }
 
         // Width of the navigation bar when presented vertically along one side
         mNavigationBarWidthForRotation[mPortraitRotation] =
@@ -1256,6 +1285,18 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             mNavigationBarCanMove = false;
         }
 
+        boolean forcePhablet = uiMode == 2;
+        if (forcePhablet) {
+            mHasSystemNavBar = false;
+            mNavigationBarCanMove = false;
+        } else {
+            boolean forceTablet = uiMode == 3;
+            if (forceTablet) {
+                mHasSystemNavBar = true;
+                mNavigationBarCanMove = false;
+            }
+        }
+
         if (!mHasSystemNavBar) {
             mHasNavigationBar = mContext.getResources().getBoolean(
                     com.android.internal.R.bool.config_showNavigationBar);
@@ -1425,6 +1466,17 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         if (updateRotation) {
             updateRotation(true);
         }
+        int NavHeight = Settings.System.getInt(resolver, Settings.System.NAVIGATION_BAR_HEIGHT, 0);
+        int NavHeightLand = Settings.System.getInt(resolver, Settings.System.NAVIGATION_BAR_HEIGHT_LANDSCAPE, 0);
+        if (NavHeight != mUserNavBarHeight || NavHeightLand != mUserNavBarHeightLand) {
+            mUserNavBarHeight = NavHeight;
+            mUserNavBarHeightLand = NavHeightLand;
+            if(mDisplay != null) {
+                setInitialDisplaySize(mDisplay, mUnrestrictedScreenWidth, mUnrestrictedScreenHeight, 
+                        SystemProperties.getInt("qemu.sf.lcd_density",
+                                SystemProperties.getInt("ro.sf.lcd_density", DisplayMetrics.DENSITY_DEFAULT)));
+            }
+        }
     }
 
     private void enablePointerLocation() {
@@ -4641,6 +4693,24 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     }
 
     ProgressDialog mBootMsgDialog = null;
+    
+    /**
+     * name of package currently being dex optimized
+     * as shown through this.showBootMessage(msg, always);
+     */
+    static String currentPackageName;
+    public void setPackageName(String pkgName) {
+        if (pkgName == null) {
+            pkgName = "stop.looking.at.me.swan";
+        }
+        this.currentPackageName = pkgName;
+    }
+
+    // debugging 'Android is upgrading...' ProgressDialog
+    final boolean DEBUG_BOOTMSG = false;
+    // this method is called to create, if needed, and update boot ProgressDialog
+    // see @link frameworks/base/services/java/com/android/server/pm/
+    //               PackageManagerService.performBootDexOpt()
 
     /** {@inheritDoc} */
     public void showBootMessage(final CharSequence msg, final boolean always) {
@@ -4687,6 +4757,21 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                     mBootMsgDialog.show();
                 }
                 mBootMsgDialog.setMessage(msg);
+                if (DEBUG_BOOTMSG) Log.d(TAG, "********** showBootMessage(" + msg +", " + always + ") updated ***********");
+                if (currentPackageName != null) {
+                    mBootMsgDialog.setTitle(msg);
+                    mBootMsgDialog.setMessage(currentPackageName);
+                    if (DEBUG_BOOTMSG) Log.d(TAG, "setTitle: " + msg + " setMessage: " + currentPackageName);
+                } else {
+                    if (DEBUG_BOOTMSG) Log.d(TAG, "failed; CURRENT_PACKAGE_NAME == null");
+                }
+                if (msg.equals(mContext.getResources().getString(R.string.android_upgrading_starting_apps))) {
+                    if (DEBUG_BOOTMSG) Log.d(TAG, "starting apps so we use normal layout");
+                    mBootMsgDialog.setTitle(R.string.android_upgrading_title);
+                    mBootMsgDialog.setMessage(mContext.getResources().getString(R.string.android_upgrading_starting_apps));
+                } else {
+                    if (DEBUG_BOOTMSG) Log.d(TAG, "not starting apps");
+                }
             }
         });
     }
diff --git a/policy/src/com/android/internal/policy/impl/keyguard/CarrierText.java b/policy/src/com/android/internal/policy/impl/keyguard/CarrierText.java
index a38e86d..2e5f25a 100644
--- a/policy/src/com/android/internal/policy/impl/keyguard/CarrierText.java
+++ b/policy/src/com/android/internal/policy/impl/keyguard/CarrierText.java
@@ -17,6 +17,7 @@
 package com.android.internal.policy.impl.keyguard;
 
 import android.content.Context;
+import android.provider.Settings;
 import android.text.TextUtils;
 import android.util.AttributeSet;
 import android.widget.TextView;
@@ -74,10 +75,16 @@ public class CarrierText extends TextView {
 
     protected void updateCarrierText(State simState, CharSequence plmn, CharSequence spn) {
         CharSequence text = getCarrierTextForSimState(simState, plmn, spn);
-        if (KeyguardViewManager.USE_UPPER_CASE) {
-            setText(text != null ? text.toString().toUpperCase() : null);
+        String customLabel = Settings.System.getString(getContext().getContentResolver(),
+                Settings.System.CUSTOM_CARRIER_LABEL);
+        if (customLabel == null || customLabel.length() == 0) {
+            if (KeyguardViewManager.USE_UPPER_CASE) {
+                setText(text != null ? text.toString().toUpperCase() : null);
+            } else {
+                setText(text);
+            }
         } else {
-            setText(text);
+            setText(customLabel);
         }
     }
 
diff --git a/services/java/com/android/server/SystemServer.java b/services/java/com/android/server/SystemServer.java
index 9decd62..10bcf1b 100644
--- a/services/java/com/android/server/SystemServer.java
+++ b/services/java/com/android/server/SystemServer.java
@@ -47,6 +47,7 @@ import android.server.search.SearchManagerService;
 import android.service.dreams.DreamService;
 import android.util.DisplayMetrics;
 import android.util.EventLog;
+import android.util.ExtendedPropertiesUtils;
 import android.util.Log;
 import android.util.Slog;
 import android.view.WindowManager;
@@ -115,6 +116,8 @@ class ServerThread extends Thread {
         BinderInternal.disableBackgroundScheduling(true);
         android.os.Process.setCanSelfBackground(false);
 
+        ExtendedPropertiesUtils.getEnvironmentState();
+
         // Check whether we failed to shut down last time we tried.
         {
             final String shutdownAction = SystemProperties.get(
diff --git a/services/java/com/android/server/pm/PackageManagerService.java b/services/java/com/android/server/pm/PackageManagerService.java
index a70f72a..91f007c 100644
--- a/services/java/com/android/server/pm/PackageManagerService.java
+++ b/services/java/com/android/server/pm/PackageManagerService.java
@@ -37,6 +37,7 @@ import com.android.internal.app.IMediaContainerService;
 import com.android.internal.app.ResolverActivity;
 import com.android.internal.content.NativeLibraryHelper;
 import com.android.internal.content.PackageHelper;
+import com.android.internal.policy.impl.PhoneWindowManager;
 import com.android.internal.util.FastXmlSerializer;
 import com.android.internal.util.XmlUtils;
 import com.android.server.DeviceStorageMonitorService;
@@ -124,6 +125,7 @@ import android.util.SparseArray;
 import android.util.Xml;
 import android.view.Display;
 import android.view.WindowManager;
+import android.view.WindowManagerPolicy;
 
 import java.io.BufferedOutputStream;
 import java.io.File;
@@ -450,6 +452,9 @@ public class PackageManagerService extends IPackageManager.Stub {
 
     // Stores a list of users whose package restrictions file needs to be updated
     private HashSet<Integer> mDirtyUsers = new HashSet<Integer>();
+    
+    WindowManager mWindowManager;
+    private final WindowManagerPolicy mPolicy; // to set packageName
 
     final private DefaultContainerConnection mDefContainerConn =
             new DefaultContainerConnection();
@@ -1012,8 +1017,9 @@ public class PackageManagerService extends IPackageManager.Stub {
 
         mInstaller = installer;
 
-        WindowManager wm = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);
-        Display d = wm.getDefaultDisplay();
+        mWindowManager = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);
+        Display d = mWindowManager.getDefaultDisplay();
+        mPolicy = new PhoneWindowManager();
         d.getMetrics(mMetrics);
 
         synchronized (mInstallLock) {
@@ -3490,8 +3496,17 @@ public class PackageManagerService extends IPackageManager.Stub {
         }
         if (pkgs != null) {
             for (int i=0; i<pkgs.size(); i++) {
+                PackageParser.Package p = pkgs.get(i);
                 if (!isFirstBoot()) {
                     try {
+                        // give the packagename to the PhoneWindowManager
+                        ApplicationInfo ai;
+                        try {
+                            ai = mContext.getPackageManager().getApplicationInfo(p.packageName, 0);
+                        } catch (Exception e) {
+                            ai = null;
+                        }
+                        mPolicy.setPackageName((String) (ai != null ? mContext.getPackageManager().getApplicationLabel(ai) : p.packageName));
                         ActivityManagerNative.getDefault().showBootMessage(
                                 mContext.getResources().getString(
                                         com.android.internal.R.string.android_upgrading_apk,
@@ -3499,7 +3514,6 @@ public class PackageManagerService extends IPackageManager.Stub {
                     } catch (RemoteException e) {
                     }
                 }
-                PackageParser.Package p = pkgs.get(i);
                 synchronized (mInstallLock) {
                     if (!p.mDidDexOpt) {
                         performDexOptLI(p, false, false);
diff --git a/services/java/com/android/server/wm/WindowManagerService.java b/services/java/com/android/server/wm/WindowManagerService.java
index 7907931..4ea5ec7 100755
--- a/services/java/com/android/server/wm/WindowManagerService.java
+++ b/services/java/com/android/server/wm/WindowManagerService.java
@@ -6838,6 +6838,23 @@ public class WindowManagerService extends IWindowManager.Stub
         sl = reduceConfigLayout(sl, Surface.ROTATION_270, density, unrotDh, unrotDw);
         outConfig.smallestScreenWidthDp = (int)(displayInfo.smallestNominalAppWidth / density);
         outConfig.screenLayout = sl;
+
+        String uiModeStr = Settings.System.getString(mContext.getContentResolver(), Settings.System.UI_MODE);
+        int uiMode = uiModeStr == null ? -1 : Integer.parseInt(uiModeStr);
+        switch (uiMode) {
+            case 1 : // phone
+                outConfig.smallestScreenWidthDp = 401;
+                break;
+            case 2 : // phablet
+                outConfig.smallestScreenWidthDp = 601;
+                break;
+            case 3 : // tablet
+                outConfig.smallestScreenWidthDp = 721;
+                break;
+            case 0 : // none
+            default:
+                break;
+        }
     }
 
     private int reduceCompatConfigWidthSize(int curSize, int rotation, DisplayMetrics dm,
-- 
1.8.0.3

